{% extends 'base.html' %}
{% block title %}Editar Mapa - {{ rot.nome }}{% endblock %}

{% block extra_css %}
<style>
/* Esconder sidebar e usar tela cheia */
.sidebar { display: none !important; }
.main-content { margin-left: 0 !important; padding: 0 !important; }
.container-fluid { padding: 0 !important; max-width: 100% !important; }
body { overflow: hidden; }
.edit-container { display: flex; height: calc(100vh - 0px); }
.edit-map { flex: 1; position: relative; }
#mapEdit { width: 100%; height: 100%; }
.edit-panel {
    width: 360px; min-width: 360px;
    background: #fff; border-left: 1px solid #dee2e6;
    display: flex; flex-direction: column; overflow: hidden;
}
.panel-header {
    padding: 1rem; background: linear-gradient(135deg, #333 0%, #20c997 100%);
    color: white; flex-shrink: 0;
}
.panel-header h5 { margin: 0; }
.panel-body { flex: 1; overflow-y: auto; padding: 0; }
.panel-footer { padding: 1rem; border-top: 1px solid #dee2e6; flex-shrink: 0; background: #f8f9fa; }
.route-item {
    padding: 0.75rem 1rem; border-bottom: 1px solid #eee;
    cursor: pointer; transition: background 0.15s;
}
.route-item:hover { background: #f8f9fa; }
.route-item.active { background: #e8f4f8; border-left: 4px solid #0d6efd; }
.route-item .route-color {
    display: inline-block; width: 14px; height: 14px;
    border-radius: 50%; margin-right: 8px; vertical-align: middle;
}
.route-item .route-stats { font-size: 0.82rem; color: #6c757d; margin-top: 4px; }
.status-badge {
    font-size: 0.7rem; padding: 2px 8px; border-radius: 10px;
    background: #e9ecef; color: #6c757d;
}
.status-badge.editing { background: #fff3cd; color: #856404; }
.status-badge.saved { background: #d1e7dd; color: #0f5132; }
.edit-instructions {
    padding: 1rem; background: #fff3cd; border-bottom: 1px solid #eee;
    font-size: 0.85rem; display: none;
}
.edit-instructions.visible { display: block; }
.modo-tabs {
    display: flex; border-bottom: 2px solid #dee2e6; flex-shrink: 0;
}
.modo-tab {
    flex: 1; padding: 0.6rem; text-align: center; cursor: pointer;
    font-weight: 600; font-size: 0.9rem; transition: all 0.2s;
    border-bottom: 3px solid transparent; color: #6c757d;
}
.modo-tab:hover { background: #f8f9fa; }
.modo-tab.active { color: #0d6efd; border-bottom-color: #0d6efd; background: #e8f4f8; }
.modo-tab.active-volta { color: #198754; border-bottom-color: #198754; background: #d1e7dd; }
@keyframes pulse-marker { 0%,100% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.3); opacity: 1; } }
.marker-pulse { animation: pulse-marker 1.5s ease-in-out infinite; }
</style>
{% endblock %}

{% block content %}
<div class="edit-container">
    <!-- Mapa -->
    <div class="edit-map">
        <div id="mapEdit"></div>
    </div>

    <!-- Painel lateral -->
    <div class="edit-panel">
        <div class="panel-header">
            <h5><i class="bi bi-pencil-square"></i> Editar Trajeto</h5>
            <small class="opacity-75">{{ rot.nome }}</small>
        </div>

        {% if tem_volta %}
        <div class="modo-tabs">
            <div class="modo-tab active" id="tabIda" onclick="alternarModo('ida')">
                <i class="bi bi-arrow-right-circle"></i> Ida
            </div>
            <div class="modo-tab" id="tabVolta" onclick="alternarModo('volta')">
                <i class="bi bi-arrow-left-circle"></i> Volta
            </div>
        </div>
        {% endif %}

        <div id="editInstructions" class="edit-instructions">
            <i class="bi bi-info-circle"></i> Arraste os pontos azuis na rota para ajustar o trajeto.
            Clique numa <strong>parada</strong> ou <strong>passageiro</strong> para mover entre rotas.
        </div>

        <div id="dispAlert" class="px-3 py-2 border-bottom" style="background:#fff3cd;display:none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-person-plus-fill text-warning"></i>
                    <strong id="dispCount">0</strong> <small>disponíveis</small>
                </div>
                <button class="btn btn-sm btn-warning" onclick="focarDisponiveis()">
                    <i class="bi bi-geo-alt"></i> Localizar
                </button>
            </div>
        </div>

        <div class="panel-body">
            <div class="p-2">
                <small class="text-muted fw-bold text-uppercase px-2">Selecione uma rota para editar</small>
            </div>
            <div id="routesList"></div>
        </div>

        <div class="panel-footer">
            <button class="btn btn-success w-100 mb-2" id="btnSalvarAlteracoes" onclick="salvarAlteracoes(false)" style="display:none;">
                <i class="bi bi-save"></i> Salvar Alterações
            </button>
            <button class="btn btn-outline-info w-100 mb-2" id="btnSalvarSimulacao" onclick="salvarAlteracoes(true)" style="display:none;">
                <i class="bi bi-layers"></i> Salvar como Simulação
            </button>
            <a href="{{ url_for('roteirizador.visualizar', id=rot.id) }}" class="btn btn-outline-secondary w-100">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=geometry&callback=initEditMap" async defer></script>
<script>
var ROUTE_COLORS = ['#E82000', '#0d6efd', '#198754', '#6f42c1', '#fd7e14', '#dc3545'];
var map, bounds;
var directionsService, directionsRenderer;
var staticPolylines = [];
var passMarkers = [];
var stopMarkers = [];
var currentRoteiroId = null;
var currentRoteiroIdx = null;
var rotaModificada = false;
var modoAtual = 'ida';
var activeInfoWindow = null;
var rotasModificadas = {};  // { roteiroId: { polyline, legs } }

var destinoPos = { lat: {{ rot.destino_lat }}, lng: {{ rot.destino_lng }} };
var rotId = {{ rot.id }};

// Dados separados ida/volta
var roteirosIdaData = [
    {% for r in roteiros_ida %}
    { id: {{ r.id }}, nome: {{ r.nome|tojson }}, idx: {{ loop.index0 }}, distKm: {{ r.distancia_km or 0 }}, durMin: {{ r.duracao_minutos or 0 }}, totalPass: {{ r.total_passageiros or 0 }}, horarioSaida: {{ r.horario_saida.strftime('%H:%M')|tojson if r.horario_saida else 'null' }} },
    {% endfor %}
];

var roteirosVoltaData = [
    {% for r in roteiros_volta %}
    { id: {{ r.id }}, nome: {{ r.nome|tojson }}, idx: {{ loop.index0 }}, distKm: {{ r.distancia_km or 0 }}, durMin: {{ r.duracao_minutos or 0 }}, totalPass: {{ r.total_passageiros or 0 }}, horarioSaida: {{ r.horario_saida.strftime('%H:%M')|tojson if r.horario_saida else 'null' }} },
    {% endfor %}
];

var paradasIdaData = [
    {% for p in paradas_ida %}
    { id: {{ p.id }}, lat: {{ p.lat }}, lng: {{ p.lng }}, nome: {{ p.nome|tojson }}, ordem: {{ p.ordem|default(0, true)|tojson }}, total: {{ p.total_passageiros }}, roteiroId: {{ p.roteiro_id|default('null', true) }} },
    {% endfor %}
];

var paradasVoltaData = [
    {% for p in paradas_volta %}
    { id: {{ p.id }}, lat: {{ p.lat }}, lng: {{ p.lng }}, nome: {{ p.nome|tojson }}, ordem: {{ p.ordem|default(0, true)|tojson }}, total: {{ p.total_passageiros }}, roteiroId: {{ p.roteiro_id|default('null', true) }} },
    {% endfor %}
];

// Rotas existentes (finalizadas do mesmo cliente+turno)
var rotasExistentes = [
    {% for r in rotas_existentes %}
    { nome: {{ r.nome|tojson }}, polyline: {{ r.polyline|tojson }} },
    {% endfor %}
];

// Passageiros disponíveis (não vinculados) para alocação
var passageirosDisponiveis = [
    {% for p in passageiros_disponiveis %}
    { id: {{ p.id }}, lat: {{ p.lat }}, lng: {{ p.lng }}, nome: {{ p.nome|tojson }}, endereco: {{ (p.endereco or '')|tojson }}{% if p.numero %}, numero: {{ p.numero|tojson }}{% endif %} },
    {% endfor %}
];
var dispMarkers = [];

var passageirosData = [
    {% for p in passageiros %}{% if p.lat and p.lng %}
    { id: {{ p.id }}, lat: {{ p.lat }}, lng: {{ p.lng }}, nome: {{ p.nome|tojson }}, endereco: {{ (p.endereco or '')|tojson }}, paradaId: {{ p.parada_id|default('null', true) }}, roteiroId: {{ p.parada.roteiro_id if p.parada and p.parada.roteiro_id else 'null' }} },
    {% endif %}{% endfor %}
];

var polylinesIdaData = [
    {% for r in roteiros_ida %}{% if r.polyline_encoded %}
    { id: {{ r.id }}, encoded: {{ r.polyline_encoded|tojson }}, idx: {{ loop.index0 }} },
    {% endif %}{% endfor %}
];

var polylinesVoltaData = [
    {% for r in roteiros_volta %}{% if r.polyline_encoded %}
    { id: {{ r.id }}, encoded: {{ r.polyline_encoded|tojson }}, idx: {{ loop.index0 }} },
    {% endif %}{% endfor %}
];

// Helpers de ícones
function personIcon(color) {
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="-2 -2 20 20">' +
        '<circle cx="8" cy="8" r="9" fill="' + color + '" stroke="white" stroke-width="1.5"/>' +
        '<path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" fill="white"/>' +
        '</svg>';
    return { url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg), scaledSize: new google.maps.Size(24, 24), anchor: new google.maps.Point(12, 12) };
}

function stopIcon(color, numero) {
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="44" viewBox="0 0 36 44">' +
        '<path d="M18 44 C18 44 36 26 36 18 C36 8 28 0 18 0 C8 0 0 8 0 18 C0 26 18 44 18 44Z" fill="' + color + '" stroke="white" stroke-width="2"/>' +
        '<circle cx="18" cy="18" r="12" fill="white" opacity="0.9"/>' +
        '<text x="18" y="23" text-anchor="middle" font-size="14" font-weight="bold" fill="' + color + '">' + numero + '</text>' +
        '</svg>';
    return { url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg), scaledSize: new google.maps.Size(32, 40), anchor: new google.maps.Point(16, 40) };
}

function getRoteirosData() { return modoAtual === 'volta' ? roteirosVoltaData : roteirosIdaData; }
function getParadasData() { return modoAtual === 'volta' ? paradasVoltaData : paradasIdaData; }
function getPolylinesData() { return modoAtual === 'volta' ? polylinesVoltaData : polylinesIdaData; }

function getRoteiroColorMap() {
    var m = {};
    getRoteirosData().forEach(function(r) { m[r.id] = ROUTE_COLORS[r.idx % ROUTE_COLORS.length]; });
    return m;
}

function getRoteiroName(roteiroId) {
    var all = roteirosIdaData.concat(roteirosVoltaData);
    var r = all.find(function(x) { return x.id === roteiroId; });
    return r ? r.nome : '?';
}

// Inicializar mapa
function initEditMap() {
    map = new google.maps.Map(document.getElementById('mapEdit'), {
        zoom: 12, center: destinoPos, mapTypeControl: true, streetViewControl: false, fullscreenControl: false
    });
    directionsService = new google.maps.DirectionsService();

    // Destino
    var destinoSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="48" viewBox="0 0 40 48">' +
        '<path d="M20 48 C20 48 40 30 40 20 C40 9 31 0 20 0 C9 0 0 9 0 20 C0 30 20 48 20 48Z" fill="#dc3545" stroke="white" stroke-width="2"/>' +
        '<rect x="11" y="9" width="18" height="22" rx="1" fill="white"/>' +
        '<rect x="14" y="12" width="4" height="4" rx="0.5" fill="#dc3545"/>' +
        '<rect x="22" y="12" width="4" height="4" rx="0.5" fill="#dc3545"/>' +
        '<rect x="14" y="19" width="4" height="4" rx="0.5" fill="#dc3545"/>' +
        '<rect x="22" y="19" width="4" height="4" rx="0.5" fill="#dc3545"/>' +
        '<rect x="17" y="25" width="6" height="6" fill="#dc3545"/>' +
        '</svg>';
    new google.maps.Marker({
        position: destinoPos, map: map,
        icon: { url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(destinoSvg), scaledSize: new google.maps.Size(36, 44), anchor: new google.maps.Point(18, 44) },
        title: 'Destino: ' + {{ rot.destino_endereco|tojson }}, zIndex: 1000
    });

    carregarModo();
}

function limparMapa() {
    // Fechar InfoWindow ativa
    if (activeInfoWindow) { activeInfoWindow.close(); activeInfoWindow = null; }

    // Limpar edição
    if (directionsRenderer) { directionsRenderer.setMap(null); directionsRenderer = null; }
    currentRoteiroId = null;
    currentRoteiroIdx = null;
    rotaModificada = false;

    // Limpar markers e polylines
    staticPolylines.forEach(function(p) { p.setMap(null); });
    staticPolylines = [];
    passMarkers.forEach(function(m) { m.setMap(null); });
    passMarkers = [];
    stopMarkers.forEach(function(m) { m.setMap(null); });
    stopMarkers = [];
    dispMarkers.forEach(function(m) { m.setMap(null); });
    dispMarkers = [];
}

var _preservarVista = false;

function carregarModo(preservarVista) {
    if (preservarVista) _preservarVista = true;
    limparMapa();

    var roteiros = getRoteirosData();
    var paradas = getParadasData();
    var polylines = getPolylinesData();
    var colorMap = getRoteiroColorMap();

    // Também mapear cores para rotas da ida (para passageiros)
    var allColorMap = {};
    roteirosIdaData.forEach(function(r) { allColorMap[r.id] = ROUTE_COLORS[r.idx % ROUTE_COLORS.length]; });
    roteirosVoltaData.forEach(function(r) { allColorMap[r.id] = ROUTE_COLORS[r.idx % ROUTE_COLORS.length]; });

    bounds = new google.maps.LatLngBounds();
    bounds.extend(destinoPos);

    // Passageiros (sempre visíveis no modo ida, baseados no roteiroId da ida)
    if (modoAtual === 'ida') {
        passageirosData.forEach(function(p) {
            var color = (p.roteiroId && allColorMap[p.roteiroId]) ? allColorMap[p.roteiroId] : '#6c757d';
            var m = new google.maps.Marker({
                position: { lat: p.lat, lng: p.lng }, map: map, icon: personIcon(color),
                title: p.nome, zIndex: 10
            });
            m._passageiroId = p.id;
            m._roteiroId = p.roteiroId;
            m._paradaId = p.paradaId;

            // InfoWindow para mover passageiro
            m.addListener('click', function() { abrirInfoPassageiro(m, p); });

            passMarkers.push(m);
            bounds.extend({ lat: p.lat, lng: p.lng });
        });

        // Passageiros disponíveis (laranja, para alocação)
        passageirosDisponiveis.forEach(function(p) {
            var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="-2 -2 20 20">' +
                '<circle cx="8" cy="8" r="9" fill="#fd7e14" stroke="white" stroke-width="2"/>' +
                '<path d="M8 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3z" fill="white"/>' +
                '<path d="M5 12.5c0-1.5 1.2-2.8 3-2.8s3 1.3 3 2.8" stroke="white" stroke-width="1.3" fill="none"/>' +
                '<line x1="6" y1="8" x2="10" y2="8" stroke="white" stroke-width="1.2"/>' +
                '<line x1="8" y1="6" x2="8" y2="10" stroke="white" stroke-width="1.2"/>' +
                '</svg>';
            var m = new google.maps.Marker({
                position: { lat: p.lat, lng: p.lng }, map: map,
                icon: { url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg), scaledSize: new google.maps.Size(30, 30), anchor: new google.maps.Point(15, 15) },
                title: p.nome + ' (disponível para alocação)',
                zIndex: 200
            });
            m._baseId = p.id;
            m.addListener('click', function() { abrirInfoAlocar(m, p); });
            dispMarkers.push(m);
            bounds.extend({ lat: p.lat, lng: p.lng });
        });

        // Mostrar/esconder alerta de disponíveis
        var dispAlert = document.getElementById('dispAlert');
        if (passageirosDisponiveis.length > 0) {
            dispAlert.style.display = 'block';
            document.getElementById('dispCount').textContent = passageirosDisponiveis.length;
        } else {
            dispAlert.style.display = 'none';
        }
    }

    // Paradas (ignorar vazias)
    paradas.forEach(function(p) {
        if (p.total <= 0) return;
        var color = (p.roteiroId && colorMap[p.roteiroId]) ? colorMap[p.roteiroId] : '#6c757d';
        var m = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng }, map: map,
            icon: stopIcon(color, p.ordem), title: p.nome + ' - ' + p.total + ' pass.', zIndex: 100
        });
        m._roteiroId = p.roteiroId;
        m._paradaId = p.id;

        // InfoWindow para mover parada
        m.addListener('click', function() { abrirInfoParada(m, p); });

        stopMarkers.push(m);
        bounds.extend({ lat: p.lat, lng: p.lng });
    });

    // Polylines
    polylines.forEach(function(r) {
        try {
            var poly = new google.maps.Polyline({
                path: google.maps.geometry.encoding.decodePath(r.encoded),
                geodesic: true, strokeColor: ROUTE_COLORS[r.idx % ROUTE_COLORS.length],
                strokeOpacity: 0.85, strokeWeight: 5, map: map
            });
            poly._roteiroId = r.id;
            poly._idx = r.idx;
            staticPolylines.push(poly);
        } catch(e) { console.error('Erro polyline:', e); }
    });

    // Rotas existentes (finalizadas) em cinza
    rotasExistentes.forEach(function(r) {
        try {
            var decoded = google.maps.geometry.encoding.decodePath(r.polyline);
            new google.maps.Polyline({
                path: decoded,
                geodesic: true,
                strokeColor: '#6c757d',
                strokeOpacity: 0.5,
                strokeWeight: 4,
                map: map,
                zIndex: 1
            });
        } catch(e) { console.error('Erro polyline existente:', e); }
    });

    // Restaurar posição salva (após alocação) ou fitBounds
    var savedZoom = sessionStorage.getItem('mapZoom');
    var savedLat = sessionStorage.getItem('mapLat');
    if (_preservarVista) {
        _preservarVista = false;
    } else if (savedZoom && savedLat) {
        map.setCenter({ lat: parseFloat(savedLat), lng: parseFloat(sessionStorage.getItem('mapLng')) });
        map.setZoom(parseInt(savedZoom));
        sessionStorage.removeItem('mapZoom');
        sessionStorage.removeItem('mapLat');
        sessionStorage.removeItem('mapLng');
    } else if (!bounds.getNorthEast().equals(bounds.getSouthWest())) {
        map.fitBounds(bounds, 50);
    }

    // Renderizar lista de rotas no painel
    renderizarListaRotas();

    // Mostrar instruções
    document.getElementById('editInstructions').classList.add('visible');
}

function renderizarListaRotas() {
    var roteiros = getRoteirosData();
    var html = '';
    roteiros.forEach(function(r) {
        var color = ROUTE_COLORS[r.idx % ROUTE_COLORS.length];
        html += '<div class="route-item" id="routeItem' + r.id + '" onclick="selecionarRota(' + r.id + ',' + r.idx + ')">';
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<div><span class="route-color" style="background:' + color + ';"></span><strong>' + r.nome + '</strong></div>';
        html += '<span class="status-badge" id="statusBadge' + r.id + '">-</span>';
        html += '</div>';
        html += '<div class="route-stats ms-4">';
        html += '<i class="bi bi-speedometer2"></i> ' + (r.distKm || '-') + ' km';
        html += ' &middot; <i class="bi bi-clock"></i> ' + (r.durMin || '-') + ' min';
        html += ' &middot; <i class="bi bi-people-fill"></i> <span id="routePass' + r.id + '">' + (r.totalPass || 0) + '</span> pass.';
        if (r.horarioSaida) {
            html += '<br><i class="bi bi-box-arrow-right"></i> Saída: ' + r.horarioSaida;
        }
        html += '</div></div>';
    });
    document.getElementById('routesList').innerHTML = html;
}

// Alternar entre ida e volta
function alternarModo(modo) {
    if (modo === modoAtual) return;
    if (rotaModificada) {
        if (!confirm('Rota atual não foi salva. Descartar alterações?')) return;
    }
    modoAtual = modo;

    // Atualizar tabs
    document.getElementById('tabIda').className = 'modo-tab' + (modo === 'ida' ? ' active' : '');
    document.getElementById('tabVolta').className = 'modo-tab' + (modo === 'volta' ? ' active-volta' : '');

    carregarModo();
}

// InfoWindow para paradas (mover entre rotas)
function abrirInfoParada(marker, parada) {
    if (activeInfoWindow) activeInfoWindow.close();

    var roteiros = getRoteirosData();
    var options = '';
    roteiros.forEach(function(r) {
        if (r.id !== parada.roteiroId) {
            options += '<option value="' + r.id + '">' + r.nome + '</option>';
        }
    });

    var content = '<div style="min-width:220px;font-size:0.9rem;">' +
        '<strong>' + parada.nome + '</strong><br>' +
        '<small class="text-muted"><i class="bi bi-people-fill"></i> ' + parada.total + ' passageiros</small><br>' +
        '<small class="text-muted">Rota: ' + getRoteiroName(parada.roteiroId) + '</small>' +
        '<hr style="margin:8px 0;">' +
        '<label style="font-size:0.8rem;font-weight:600;">Mover para outra rota:</label>' +
        '<select id="selectMoverParada" class="form-select form-select-sm mt-1">' +
        '<option value="">-- Selecione --</option>' + options + '</select>' +
        '<button class="btn btn-sm btn-primary w-100 mt-2" onclick="moverParada(' + parada.id + ')">Mover Parada</button>' +
        '</div>';

    activeInfoWindow = new google.maps.InfoWindow({ content: content });
    activeInfoWindow.open(map, marker);
}

// InfoWindow para passageiros (mover para outra rota)
function abrirInfoPassageiro(marker, pass) {
    if (activeInfoWindow) activeInfoWindow.close();

    var roteiros = getRoteirosData();
    var paradaAtual = getParadasData().find(function(p) { return p.id === pass.paradaId; });
    var rotaAtualId = paradaAtual ? paradaAtual.roteiroId : pass.roteiroId;
    var rotaAtual = rotaAtualId ? getRoteiroName(rotaAtualId) : '-';

    var options = '';
    roteiros.forEach(function(r) {
        if (r.id !== rotaAtualId) {
            var color = ROUTE_COLORS[r.idx % ROUTE_COLORS.length];
            options += '<option value="' + r.id + '">' + r.nome + ' (' + r.totalPass + ' pass.)</option>';
        }
    });

    var content = '<div style="min-width:250px;font-size:0.9rem;">' +
        '<strong>' + pass.nome + '</strong><br>' +
        '<small class="text-muted">' + (pass.endereco || '') + '</small><br>' +
        '<small class="text-muted">Parada: ' + (paradaAtual ? paradaAtual.nome : '-') + '</small><br>' +
        '<small class="text-muted">Rota: ' + rotaAtual + '</small>' +
        '<hr style="margin:8px 0;">' +
        '<label style="font-size:0.8rem;font-weight:600;">Mover para outra rota:</label>' +
        '<select id="selectMoverPassageiro" class="form-select form-select-sm mt-1">' +
        '<option value="">-- Selecione --</option>' + options + '</select>' +
        '<small class="text-muted">Uma nova parada será criada na posição do passageiro.</small>' +
        '<button class="btn btn-sm btn-primary w-100 mt-2" onclick="moverPassageiro(' + pass.id + ')">Mover Passageiro</button>' +
        '</div>';

    activeInfoWindow = new google.maps.InfoWindow({ content: content });
    activeInfoWindow.open(map, marker);
}

// Recalcular polyline de uma rota via Google Directions API
function recalcularPolylineRota(roteiroId, callback) {
    var paradas = getParadasData();
    var polylines = getPolylinesData();
    var paradasRota = paradas.filter(function(p) { return p.roteiroId === roteiroId && p.total > 0; });
    paradasRota.sort(function(a, b) { return a.ordem - b.ordem; });
    console.log('recalcularPolyline roteiroId=' + roteiroId + ', paradas=' + paradasRota.length + ', polylines=' + polylines.length);

    // Remover polyline antiga deste roteiro
    var polyIdx = polylines.findIndex(function(pl) { return pl.id === roteiroId; });

    if (paradasRota.length === 0) {
        // Rota ficou sem paradas: remover polyline
        if (polyIdx >= 0) polylines.splice(polyIdx, 1);
        rotasModificadas[roteiroId] = { polyline: '', legs: [] };
        mostrarBotoesSalvar();
        if (callback) callback();
        return;
    }

    var origin = { lat: paradasRota[0].lat, lng: paradasRota[0].lng };
    var waypoints = [];
    for (var i = 1; i < paradasRota.length; i++) {
        waypoints.push({ location: { lat: paradasRota[i].lat, lng: paradasRota[i].lng }, stopover: true });
    }

    directionsService.route({
        origin: origin, destination: destinoPos,
        waypoints: waypoints, travelMode: google.maps.TravelMode.DRIVING
    }, function(result, status) {
        console.log('Directions API status=' + status);
        if (status === 'OK') {
            var route = result.routes[0];
            var encoded = google.maps.geometry.encoding.encodePath(route.overview_path);
            var roteiros = getRoteirosData();
            var rot = roteiros.find(function(r) { return r.id === roteiroId; });
            var idx = rot ? rot.idx : 0;
            console.log('Polyline atualizada, polyIdx=' + polyIdx + ', rot encontrado=' + !!rot + ', idx=' + idx);

            if (polyIdx >= 0) {
                polylines[polyIdx].encoded = encoded;
                polylines[polyIdx].idx = idx;
            } else {
                polylines.push({ id: roteiroId, encoded: encoded, idx: idx });
            }

            // Capturar legs para salvar depois
            var legs = route.legs.map(function(leg) {
                return { distance_m: leg.distance.value, duration_s: leg.duration.value };
            });

            // Atualizar métricas locais do roteiro
            if (rot) {
                var totalDist = legs.reduce(function(s, l) { return s + l.distance_m; }, 0);
                var totalDur = legs.reduce(function(s, l) { return s + l.duration_s; }, 0);
                rot.distKm = (totalDist / 1000).toFixed(1);
                rot.durMin = Math.round(totalDur / 60);
            }

            rotasModificadas[roteiroId] = { polyline: encoded, legs: legs };
            mostrarBotoesSalvar();
        }
        if (callback) callback();
    });
}

function mostrarBotoesSalvar() {
    var temAlteracoes = Object.keys(rotasModificadas).length > 0;
    document.getElementById('btnSalvarAlteracoes').style.display = temAlteracoes ? 'block' : 'none';
    document.getElementById('btnSalvarSimulacao').style.display = temAlteracoes ? 'block' : 'none';
}

function salvarAlteracoes(comoSimulacao) {
    var rotas = [];
    for (var roteiroId in rotasModificadas) {
        var item = {
            roteiro_id: parseInt(roteiroId),
            polyline: rotasModificadas[roteiroId].polyline,
            legs: rotasModificadas[roteiroId].legs
        };
        if (rotasModificadas[roteiroId].waypoints) {
            item.waypoints = rotasModificadas[roteiroId].waypoints;
        }
        rotas.push(item);
    }

    var url = comoSimulacao
        ? '/roteirizador/' + rotId + '/salvar_simulacao_mapa'
        : '/roteirizador/' + rotId + '/salvar_polylines';

    var btnId = comoSimulacao ? 'btnSalvarSimulacao' : 'btnSalvarAlteracoes';
    var btn = document.getElementById(btnId);
    var originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Salvando...';

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rotas: rotas })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        if (data.ok) {
            // Marcar rotas como salvas
            for (var rid in rotasModificadas) {
                var badge = document.getElementById('statusBadge' + rid);
                if (badge) { badge.textContent = 'Salva'; badge.className = 'status-badge saved'; }
            }
            rotaModificada = false;

            if (comoSimulacao) {
                alert(data.msg);
            } else {
                rotasModificadas = {};
                mostrarBotoesSalvar();
                alert(data.msg);
            }
        } else {
            alert('Erro: ' + (data.msg || 'Falha ao salvar'));
        }
    })
    .catch(function(err) {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        alert('Erro: ' + err);
    });
}

// Executar mover parada
function moverParada(paradaId) {
    var sel = document.getElementById('selectMoverParada');
    if (!sel || !sel.value) { alert('Selecione uma rota de destino.'); return; }
    var roteiroDestinoId = parseInt(sel.value);

    // Encontrar roteiro de origem antes de mover
    var paradas = getParadasData();
    var parada = paradas.find(function(p) { return p.id === paradaId; });
    var roteiroOrigemId = parada ? parada.roteiroId : null;

    if (activeInfoWindow) { activeInfoWindow.close(); activeInfoWindow = null; }

    fetch('/roteirizador/' + rotId + '/mover_parada', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ parada_id: paradaId, roteiro_destino_id: roteiroDestinoId })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.ok) {
            // Atualizar dados locais
            if (parada) {
                parada.roteiroId = roteiroDestinoId;
                var maxOrdem = 0;
                paradas.forEach(function(p) { if (p.roteiroId === roteiroDestinoId && p.id !== paradaId && p.ordem > maxOrdem) maxOrdem = p.ordem; });
                parada.ordem = maxOrdem + 1;
            }

            // Resequenciar paradas na rota de origem
            var seq = 1;
            paradas.filter(function(p) { return p.roteiroId === roteiroOrigemId; })
                .sort(function(a, b) { return a.ordem - b.ordem; })
                .forEach(function(p) { p.ordem = seq++; });

            // Atualizar passageiros que estavam nessa parada
            passageirosData.forEach(function(p) {
                if (p.paradaId === paradaId) p.roteiroId = roteiroDestinoId;
            });

            // Atualizar contadores nas rotas
            var roteiros = getRoteirosData();
            roteiros.forEach(function(r) {
                if (r.id === data.roteiro_origem_id) r.totalPass = data.total_pass_origem;
                if (r.id === data.roteiro_destino_id) r.totalPass = data.total_pass_destino;
            });

            // Recalcular polylines de ambas as rotas afetadas
            recalcularPolylineRota(roteiroOrigemId, function() {
                recalcularPolylineRota(roteiroDestinoId, function() {
                    carregarModo(true);
                });
            });
        } else {
            alert('Erro: ' + (data.msg || 'Falha'));
        }
    })
    .catch(function(err) { alert('Erro: ' + err); });
}

// Executar mover passageiro para outra rota
function moverPassageiro(passageiroId) {
    var sel = document.getElementById('selectMoverPassageiro');
    if (!sel || !sel.value) { alert('Selecione uma rota de destino.'); return; }
    var roteiroDestinoId = parseInt(sel.value);

    if (activeInfoWindow) { activeInfoWindow.close(); activeInfoWindow = null; }

    fetch('/roteirizador/' + rotId + '/mover_passageiro', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ passageiro_id: passageiroId, roteiro_destino_id: roteiroDestinoId })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.ok) {
            // Atualizar dados locais do passageiro
            var pass = passageirosData.find(function(p) { return p.id === passageiroId; });
            if (pass) {
                pass.paradaId = data.nova_parada.id;
                pass.roteiroId = data.roteiro_destino_id;
            }

            var paradas = getParadasData();

            // Se a parada de origem ficou vazia, remover do array local
            if (data.parada_origem_vazia && data.parada_origem_id) {
                var idxRemove = paradas.findIndex(function(p) { return p.id === data.parada_origem_id; });
                if (idxRemove >= 0) paradas.splice(idxRemove, 1);
            } else if (data.parada_origem_id) {
                var pOrig = paradas.find(function(p) { return p.id === data.parada_origem_id; });
                if (pOrig) pOrig.total = pOrig.total - 1;
            }

            // Adicionar nova parada ao array local
            paradas.push(data.nova_parada);

            // Atualizar ordens das paradas da rota destino (backend calcula melhor posição)
            if (data.paradas_destino_atualizadas) {
                data.paradas_destino_atualizadas.forEach(function(pa) {
                    var p = paradas.find(function(x) { return x.id === pa.id; });
                    if (p) p.ordem = pa.ordem;
                });
            }

            // Atualizar contadores nas rotas
            var roteiros = getRoteirosData();
            if (data.roteiro_origem_id) {
                var rOrig = roteiros.find(function(r) { return r.id === data.roteiro_origem_id; });
                if (rOrig) rOrig.totalPass = data.total_pass_origem;
            }
            var rDest = roteiros.find(function(r) { return r.id === data.roteiro_destino_id; });
            if (rDest) rDest.totalPass = data.total_pass_destino;

            // Recalcular polyline da rota destino (para incluir a nova parada)
            recalcularPolylineRota(roteiroDestinoId, function() {
                // Se a parada de origem foi removida, recalcular polyline da rota origem também
                if (data.parada_origem_vazia && data.roteiro_origem_id) {
                    recalcularPolylineRota(data.roteiro_origem_id, function() {
                        carregarModo(true);
                    });
                } else {
                    carregarModo(true);
                }
            });
        } else {
            alert('Erro: ' + (data.msg || 'Falha'));
        }
    })
    .catch(function(err) { alert('Erro: ' + err); });
}

// Seleção de rota para editar trajeto (drag-and-drop)
function selecionarRota(roteiroId, idx) {
    if (currentRoteiroId === roteiroId) return;

    if (rotaModificada) {
        if (!confirm('Rota atual não foi salva. Descartar alterações?')) return;
    }

    // Fechar InfoWindow
    if (activeInfoWindow) { activeInfoWindow.close(); activeInfoWindow = null; }

    // Limpar edição anterior
    if (directionsRenderer) {
        directionsRenderer.setMap(null);
        directionsRenderer = null;
    }

    // Restaurar polylines estáticas
    staticPolylines.forEach(function(p) { p.setMap(map); });
    stopMarkers.forEach(function(m) { m.setMap(map); });

    // Atualizar UI
    document.querySelectorAll('.route-item').forEach(function(el) { el.classList.remove('active'); });
    document.getElementById('routeItem' + roteiroId).classList.add('active');

    currentRoteiroId = roteiroId;
    currentRoteiroIdx = idx;
    rotaModificada = false;

    // Esconder polyline estática da rota selecionada
    staticPolylines.forEach(function(p) {
        if (p._roteiroId === roteiroId) p.setMap(null);
    });

    // Esconder paradas de OUTRAS rotas (manter só as da rota editada)
    stopMarkers.forEach(function(m) {
        m.setMap(m._roteiroId === roteiroId ? null : map);
    });

    // Criar DirectionsRenderer
    var routeColor = ROUTE_COLORS[idx % ROUTE_COLORS.length];
    directionsRenderer = new google.maps.DirectionsRenderer({
        map: map, draggable: true, suppressMarkers: false,
        polylineOptions: { strokeColor: routeColor, strokeWeight: 6, strokeOpacity: 0.9 }
    });

    directionsRenderer.addListener('directions_changed', function() {
        rotaModificada = true;
        var badge = document.getElementById('statusBadge' + roteiroId);
        badge.textContent = 'Modificada';
        badge.className = 'status-badge editing';

        // Capturar dados do drag para salvar depois
        var dirs = directionsRenderer.getDirections();
        if (dirs && dirs.routes && dirs.routes[0]) {
            var route = dirs.routes[0];
            var encoded = google.maps.geometry.encoding.encodePath(route.overview_path);
            var legs = route.legs.map(function(leg) {
                return { distance_m: leg.distance.value, duration_s: leg.duration.value };
            });

            var paradasAtual = getParadasData();
            var paradasRoteiro = paradasAtual.filter(function(p) { return p.roteiroId === roteiroId && p.total > 0; });
            var waypoints = [];
            for (var i = 0; i < route.legs.length && i < paradasRoteiro.length; i++) {
                var loc = route.legs[i].start_location;
                waypoints.push({ lat: loc.lat(), lng: loc.lng(), parada_id: paradasRoteiro[i].id });
            }

            rotasModificadas[roteiroId] = { polyline: encoded, legs: legs, waypoints: waypoints };
            mostrarBotoesSalvar();
        }
    });

    // Carregar rota no DirectionsRenderer
    var paradasAtual = getParadasData();
    var paradasRoteiro = paradasAtual.filter(function(p) { return p.roteiroId === roteiroId && p.total > 0; });

    if (paradasRoteiro.length === 0) {
        alert('Nenhuma parada nesta rota.');
        return;
    }

    var origin = { lat: paradasRoteiro[0].lat, lng: paradasRoteiro[0].lng };
    var waypoints = [];
    for (var i = 1; i < paradasRoteiro.length; i++) {
        waypoints.push({ location: { lat: paradasRoteiro[i].lat, lng: paradasRoteiro[i].lng }, stopover: true });
    }

    directionsService.route({
        origin: origin, destination: destinoPos,
        waypoints: waypoints, travelMode: google.maps.TravelMode.DRIVING
    }, function(result, status) {
        if (status === 'OK') {
            directionsRenderer.setDirections(result);
        } else {
            alert('Erro ao carregar rota: ' + status);
        }
    });
}

// ============================================
// PASSAGEIROS DISPONÍVEIS - LOCALIZAR
// ============================================

function focarDisponiveis() {
    if (dispMarkers.length === 0) return;
    var b = new google.maps.LatLngBounds();
    dispMarkers.forEach(function(m) { b.extend(m.getPosition()); });
    map.fitBounds(b, 80);

    // Efeito de bounce nos marcadores
    dispMarkers.forEach(function(m) {
        m.setAnimation(google.maps.Animation.BOUNCE);
        setTimeout(function() { m.setAnimation(null); }, 2000);
    });
}

// ============================================
// ALOCAR PASSAGEIRO DISPONÍVEL
// ============================================

function calcDistancia(lat1, lng1, lat2, lng2) {
    var R = 6371000;
    var dLat = (lat2 - lat1) * Math.PI / 180;
    var dLng = (lng2 - lng1) * Math.PI / 180;
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng/2) * Math.sin(dLng/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function abrirInfoAlocar(marker, passDisp) {
    if (activeInfoWindow) activeInfoWindow.close();

    var roteiros = getRoteirosData();
    var paradas = getParadasData();

    // Para cada rota, encontrar a parada mais próxima e ordenar por distância
    var rotasComDist = [];
    roteiros.forEach(function(r) {
        var paradasRota = paradas.filter(function(p) { return p.roteiroId === r.id && p.total > 0; });
        var menorDist = Infinity;
        paradasRota.forEach(function(p) {
            var d = calcDistancia(passDisp.lat, passDisp.lng, p.lat, p.lng);
            if (d < menorDist) menorDist = d;
        });
        rotasComDist.push({ r: r, dist: menorDist });
    });
    rotasComDist.sort(function(a, b) { return a.dist - b.dist; });

    var opcoesRotas = '';
    rotasComDist.forEach(function(item) {
        var r = item.r;
        var distTxt = item.dist < Infinity ? Math.round(item.dist) + 'm' : '-';
        opcoesRotas += '<option value="' + r.id + '">' +
            r.nome + ' (' + r.totalPass + ' pass. | ' + distTxt + ')</option>';
    });

    // Paradas da primeira rota (atualizado via JS ao trocar rota)
    var content = '<div style="min-width:280px;font-size:0.9rem;">' +
        '<div style="background:#6c757d;color:white;padding:6px 10px;margin:-8px -8px 8px -8px;border-radius:4px 4px 0 0;">' +
        '<strong><i class="bi bi-person-plus"></i> Alocar Passageiro</strong></div>' +
        '<strong>' + passDisp.nome + '</strong><br>' +
        '<small class="text-muted">' + (passDisp.endereco || '') + (passDisp.numero ? ', ' + passDisp.numero : '') + '</small>' +
        '<hr style="margin:8px 0;">' +
        '<label style="font-size:0.8rem;font-weight:600;">Rota destino:</label>' +
        '<select id="selectAlocarRota" class="form-select form-select-sm mt-1" onchange="atualizarParadasAlocar(' + passDisp.id + ')">' +
        '<option value="">-- Selecione a rota --</option>' + opcoesRotas + '</select>' +
        '<div id="alocModo" style="display:none;margin-top:8px;">' +
        '<div class="form-check form-check-inline">' +
        '<input class="form-check-input" type="radio" name="alocModo" id="alocExistente" value="existente" checked>' +
        '<label class="form-check-label" for="alocExistente" style="font-size:0.8rem;">Parada existente</label></div>' +
        '<div class="form-check form-check-inline">' +
        '<input class="form-check-input" type="radio" name="alocModo" id="alocNova" value="nova">' +
        '<label class="form-check-label" for="alocNova" style="font-size:0.8rem;">Nova parada</label></div>' +
        '<div id="selectParadaContainer" style="margin-top:4px;"></div>' +
        '</div>' +
        '<button class="btn btn-sm btn-success w-100 mt-2" id="btnAlocar" onclick="alocarPassageiro(' + passDisp.id + ')" style="display:none;">' +
        '<i class="bi bi-plus-circle"></i> Alocar</button>' +
        '</div>';

    activeInfoWindow = new google.maps.InfoWindow({ content: content });
    activeInfoWindow.open(map, marker);

    // Listener para alternar modo
    google.maps.event.addListenerOnce(activeInfoWindow, 'domready', function() {
        var radios = document.querySelectorAll('input[name="alocModo"]');
        radios.forEach(function(r) {
            r.addEventListener('change', function() {
                var container = document.getElementById('selectParadaContainer');
                container.style.display = this.value === 'existente' ? 'block' : 'none';
            });
        });
    });
}

function atualizarParadasAlocar(baseId) {
    var roteiroId = parseInt(document.getElementById('selectAlocarRota').value);
    var modoDiv = document.getElementById('alocModo');
    var btnAlocar = document.getElementById('btnAlocar');

    if (!roteiroId) {
        modoDiv.style.display = 'none';
        btnAlocar.style.display = 'none';
        return;
    }

    modoDiv.style.display = 'block';
    btnAlocar.style.display = 'block';

    // Reset para modo "existente"
    document.getElementById('alocExistente').checked = true;
    var container = document.getElementById('selectParadaContainer');
    container.style.display = 'block';

    // Carregar paradas da rota selecionada, ordenadas por distância (incluir todas ativas)
    var paradas = getParadasData().filter(function(p) { return p.roteiroId === roteiroId; });
    var passDisp = passageirosDisponiveis.find(function(p) { return p.id === baseId; });

    // Calcular distância e ordenar
    var paradasComDist = paradas.map(function(p) {
        return { p: p, dist: passDisp ? calcDistancia(passDisp.lat, passDisp.lng, p.lat, p.lng) : 0 };
    }).sort(function(a, b) { return a.dist - b.dist; });

    var html = '<select id="selectAlocarParada" class="form-select form-select-sm">';
    paradasComDist.forEach(function(item, idx) {
        var distTxt = Math.round(item.dist) + 'm';
        html += '<option value="' + item.p.id + '"' + (idx === 0 ? ' selected' : '') + '>' +
            item.p.nome + ' (' + item.p.total + ' pass. | ' + distTxt + ')</option>';
    });
    html += '</select>';
    container.innerHTML = html;
}

function alocarPassageiro(baseId) {
    var roteiroId = parseInt(document.getElementById('selectAlocarRota').value);
    if (!roteiroId) { alert('Selecione uma rota.'); return; }

    var modo = document.querySelector('input[name="alocModo"]:checked').value;
    var paradaId = null;
    if (modo === 'existente') {
        var sel = document.getElementById('selectAlocarParada');
        if (!sel || !sel.value) { alert('Selecione uma parada.'); return; }
        paradaId = parseInt(sel.value);
    }

    if (activeInfoWindow) { activeInfoWindow.close(); activeInfoWindow = null; }

    var payload = { passageiro_base_id: baseId, roteiro_id: roteiroId };
    if (modo === 'existente' && paradaId) {
        payload.parada_id = paradaId;
    } else if (modo === 'nova') {
        payload.criar_nova = true;
    }

    fetch('/roteirizador/' + rotId + '/alocar_passageiro', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.ok) {
            // Salvar posição do mapa e recarregar
            var c = map.getCenter();
            sessionStorage.setItem('mapZoom', map.getZoom());
            sessionStorage.setItem('mapLat', c.lat());
            sessionStorage.setItem('mapLng', c.lng());
            window.location.reload();
        } else {
            alert('Erro: ' + (data.msg || 'Falha'));
        }
    })
    .catch(function(err) { alert('Erro: ' + err); });
}

</script>
{% endblock %}
