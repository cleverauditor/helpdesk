{% extends 'base.html' %}

{% block title %}Rota {{ rota.tag }} - Auditoria{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-signpost-2"></i> Rota: {{ rota.tag }}
        {% if not rota.ativo %}
        <span class="badge bg-secondary">Inativa</span>
        {% endif %}
    </h2>
    <div>
        <a href="{{ url_for('auditoria.processar_auditoria', rota_id=rota.id) }}" class="btn btn-success me-2">
            <i class="bi bi-clipboard-check"></i> Auditar
        </a>
        <a href="{{ url_for('auditoria.editar_rota', id=rota.id) }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-pencil"></i> Editar
        </a>
        <a href="{{ url_for('auditoria.lista_rotas') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<div class="row">
    <!-- Coluna Principal -->
    <div class="col-md-8">
        <!-- Dados da Rota -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Dados da Rota
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="text-muted" width="40%">Tag:</td>
                                <td><strong>{{ rota.tag }}</strong></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Nome:</td>
                                <td>{{ rota.nome or '-' }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Cliente:</td>
                                <td>{{ rota.cliente.nome }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Modal:</td>
                                <td>
                                    {% if rota.modal %}
                                    <span class="badge bg-info">{{ rota.modal.nome }}</span>
                                    {% else %}
                                    <span class="text-muted">Não definido</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="text-muted" width="50%">KM Atual:</td>
                                <td><strong>{{ rota.km_atual }} km</strong></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Implantação:</td>
                                <td>{{ rota.data_implantacao.strftime('%d/%m/%Y') if rota.data_implantacao else '-' }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Arquivo KML:</td>
                                <td>
                                    {% if rota.arquivo_kml %}
                                    <a href="{{ url_for('auditoria.download_kml', tipo='rota', id=rota.id) }}">
                                        <i class="bi bi-download"></i> {{ rota.arquivo_kml_nome }}
                                    </a>
                                    {% else %}
                                    <span class="text-muted">Não enviado</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Turnos -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock"></i> Turnos</span>
                <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#formTurno">
                    <i class="bi bi-plus"></i> Adicionar Turno
                </button>
            </div>
            <div class="card-body">
                <!-- Formulário de novo turno (colapsado) -->
                <div class="collapse mb-3" id="formTurno">
                    <form method="POST" action="{{ url_for('auditoria.criar_turno', id=rota.id) }}" class="card card-body bg-light">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Nome</label>
                                <input type="text" name="nome" class="form-control" placeholder="Ex: Manhã">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Início *</label>
                                <input type="time" name="horario_inicio" class="form-control" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Término *</label>
                                <input type="time" name="horario_termino" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tempo Trajeto (min)</label>
                                <input type="number" name="tempo_trajeto_minutos" class="form-control" placeholder="Ex: 90">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-check"></i> Adicionar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Lista de turnos -->
                {% if turnos %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Início</th>
                                <th>Término</th>
                                <th>Tempo Trajeto</th>
                                <th width="100">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for turno in turnos %}
                            <tr>
                                <td>{{ turno.nome or '-' }}</td>
                                <td>{{ turno.horario_inicio.strftime('%H:%M') }}</td>
                                <td>{{ turno.horario_termino.strftime('%H:%M') }}</td>
                                <td>{{ turno.tempo_trajeto_formatado() }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            onclick="editarTurno({{ turno.id }}, '{{ turno.nome or '' }}', '{{ turno.horario_inicio.strftime('%H:%M') }}', '{{ turno.horario_termino.strftime('%H:%M') }}', {{ turno.tempo_trajeto_minutos or 0 }})"
                                            data-bs-toggle="modal" data-bs-target="#modalEditarTurno">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <form method="POST" action="{{ url_for('auditoria.excluir_turno', id=turno.id) }}"
                                          style="display:inline" onsubmit="return confirm('Remover este turno?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center mb-0">Nenhum turno cadastrado.</p>
                {% endif %}
            </div>
        </div>

        <!-- Histórico -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Histórico
            </div>
            <div class="card-body">
                {% if historicos %}
                <div class="timeline">
                    {% for h in historicos %}
                    <div class="timeline-item">
                        <small class="text-muted">{{ h.criado_em.strftime('%d/%m/%Y %H:%M') }}</small>
                        <p class="mb-1">
                            <strong>{{ h.usuario.nome }}</strong>
                            <span class="badge bg-secondary">{{ h.acao.replace('_', ' ').title() }}</span>
                        </p>
                        {% if h.descricao %}
                        <p class="mb-0 small text-muted">{{ h.descricao }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center mb-0">Nenhum registro no histórico.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Última Auditoria -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-clipboard-check"></i> Última Auditoria
            </div>
            <div class="card-body">
                {% if auditorias %}
                {% set ultima = auditorias[0] %}
                <p class="mb-1">
                    <strong>Data:</strong> {{ ultima.data_auditoria.strftime('%d/%m/%Y') }}
                </p>
                <p class="mb-1">
                    <strong>Atendente:</strong> {{ ultima.atendente.nome }}
                </p>
                {% if ultima.km_planejado or rota.km_atual %}
                <p class="mb-1">
                    <strong>KM Planejado:</strong> {{ ultima.km_planejado or rota.km_atual }} km
                </p>
                {% endif %}
                {% if ultima.km_percorrido %}
                <p class="mb-1">
                    <strong>KM Percorrido:</strong> {{ ultima.km_percorrido }} km
                </p>
                {% endif %}
                {% if ultima.aderencia_percentual is not none %}
                <p class="mb-1">
                    <strong>Aderência:</strong>
                    <span class="badge bg-{{ 'success' if ultima.aderencia_percentual >= 90 else 'warning' if ultima.aderencia_percentual >= 70 else 'danger' }}">
                        {{ ultima.aderencia_percentual }}%
                    </span>
                </p>
                {% endif %}
                <hr>
                <a href="{{ url_for('auditoria.lista_auditorias') }}?rota_id={{ rota.id }}"
                   class="btn btn-outline-primary btn-sm w-100">
                    Ver todas ({{ rota.auditorias.count() }})
                </a>
                {% else %}
                <p class="text-muted text-center mb-0">Nenhuma auditoria realizada.</p>
                {% endif %}
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning"></i> Ações Rápidas
            </div>
            <div class="card-body d-grid gap-2">
                <a href="{{ url_for('auditoria.processar_auditoria', rota_id=rota.id) }}" class="btn btn-success">
                    <i class="bi bi-clipboard-check"></i> Realizar Auditoria
                </a>
                <a href="{{ url_for('auditoria.editar_rota', id=rota.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil"></i> Editar Rota
                </a>
                {% if rota.arquivo_kml %}
                <a href="{{ url_for('auditoria.download_kml', tipo='rota', id=rota.id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-download"></i> Baixar KML Planejado
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Turno -->
<div class="modal fade" id="modalEditarTurno" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formEditarTurno" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Turno</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome</label>
                        <input type="text" name="nome" id="editTurnoNome" class="form-control">
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Início *</label>
                                <input type="time" name="horario_inicio" id="editTurnoInicio" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Término *</label>
                                <input type="time" name="horario_termino" id="editTurnoTermino" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tempo Trajeto (minutos)</label>
                        <input type="number" name="tempo_trajeto_minutos" id="editTurnoTempo" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editarTurno(id, nome, inicio, termino, tempo) {
    document.getElementById('formEditarTurno').action = '/auditoria/turnos/' + id + '/editar';
    document.getElementById('editTurnoNome').value = nome;
    document.getElementById('editTurnoInicio').value = inicio;
    document.getElementById('editTurnoTermino').value = termino;
    document.getElementById('editTurnoTempo').value = tempo || '';
}
</script>
{% endblock %}
