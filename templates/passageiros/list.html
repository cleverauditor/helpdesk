{% extends 'base.html' %}

{% block title %}Passageiros - Sistemas MaxVia{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people"></i> Passageiros</h2>
    <div>
        <a href="{{ url_for('passageiros.importar') }}" class="btn btn-outline-success me-2">
            <i class="bi bi-upload"></i> Importar
        </a>
        <a href="{{ url_for('passageiros.criar') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Novo Passageiro
        </a>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Cliente</label>
                <select name="cliente_id" id="filtro_cliente" class="form-select">
                    <option value="">Todos</option>
                    {% for c in clientes %}
                    <option value="{{ c.id }}" {{ 'selected' if request.args.get('cliente_id', '')|int == c.id }}>
                        {{ c.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Turno</label>
                <select name="turno_id" id="filtro_turno" class="form-select">
                    <option value="">Todos</option>
                    {% for t in turnos %}
                    <option value="{{ t.id }}" {{ 'selected' if request.args.get('turno_id', '')|int == t.id }}>
                        {{ t.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Vínculo</label>
                <select name="vinculo" class="form-select">
                    <option value="">Todos</option>
                    <option value="disponivel" {{ 'selected' if request.args.get('vinculo') == 'disponivel' }}>Disponível</option>
                    <option value="vinculado" {{ 'selected' if request.args.get('vinculo') == 'vinculado' }}>Vinculado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Buscar</label>
                <input type="text" name="busca" class="form-control"
                       value="{{ request.args.get('busca', '') }}"
                       placeholder="Nome, endereço, bairro...">
            </div>
            <div class="col-md-2 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Filtrar
                </button>
                <a href="{{ url_for('passageiros.lista') }}" class="btn btn-outline-secondary" title="Limpar">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Ações em lote -->
{% set cliente_id_filtro = request.args.get('cliente_id', '')|int %}
{% set turno_id_filtro = request.args.get('turno_id', '')|int %}
{% if cliente_id_filtro %}
<div class="mb-3">
    <form method="POST" action="{{ url_for('passageiros.geocodificar') }}" style="display:inline">
        <input type="hidden" name="cliente_id" value="{{ cliente_id_filtro }}">
        {% if turno_id_filtro %}
        <input type="hidden" name="turno_id" value="{{ turno_id_filtro }}">
        {% endif %}
        <button type="submit" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-geo-alt"></i> Geocodificar pendentes
        </button>
    </form>
</div>
{% endif %}

<!-- Lista -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Nome</th>
                        <th>Endereço</th>
                        <th>Bairro/Cidade</th>
                        <th>Cliente/Turno</th>
                        <th>Geocode</th>
                        <th>Vínculo</th>
                        <th width="150">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in passageiros.items %}
                    <tr>
                        <td>
                            <strong>{{ p.nome }}</strong>
                            {% if p.telefone %}
                            <br><small class="text-muted">{{ p.telefone }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ p.endereco or '' }}{% if p.numero %}, {{ p.numero }}{% endif %}
                            {% if p.complemento %}<br><small class="text-muted">{{ p.complemento }}</small>{% endif %}
                        </td>
                        <td>
                            {{ p.bairro or '-' }}
                            {% if p.cidade %}<br><small>{{ p.cidade }}{% if p.estado %}/{{ p.estado }}{% endif %}</small>{% endif %}
                        </td>
                        <td>
                            <small>{{ p.cliente.nome }}</small>
                            <br><span class="badge bg-light text-dark">{{ p.turno.nome }}</span>
                        </td>
                        <td>
                            {% if p.geocode_status == 'sucesso' %}
                            <span class="badge bg-success">OK</span>
                            {% elif p.geocode_status == 'falha' %}
                            <span class="badge bg-danger">Falha</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">Pendente</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if p.roteirizacao_vinculada_id %}
                            <a href="{{ url_for('roteirizador.visualizar', id=p.roteirizacao_vinculada_id) }}" class="text-decoration-none">
                                <span class="badge bg-info">{{ p.roteirizacao_vinculada.nome }}</span>
                            </a>
                            {% set passageiro_rot = p.instancias_roteirizacao|selectattr('roteirizacao_id', 'equalto', p.roteirizacao_vinculada_id)|first %}
                            {% if passageiro_rot and passageiro_rot.parada and passageiro_rot.parada.roteiro %}
                            <br><small class="text-muted">{{ passageiro_rot.parada.roteiro.nome }}</small>
                            {% endif %}
                            {% else %}
                            <span class="badge bg-secondary">Disponível</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('passageiros.editar', id=p.id) }}"
                               class="btn btn-sm btn-outline-secondary" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </a>
                            {% if p.roteirizacao_vinculada_id %}
                            <form method="POST" action="{{ url_for('passageiros.desvincular', id=p.id) }}"
                                  style="display:inline"
                                  onsubmit="return confirm('Desvincular passageiro da rota?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Desvincular">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                            </form>
                            {% endif %}
                            <form method="POST" action="{{ url_for('passageiros.toggle', id=p.id) }}"
                                  style="display:inline">
                                <button type="submit"
                                        class="btn btn-sm btn-outline-danger" title="Desativar">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-people" style="font-size: 2rem;"></i>
                            <p class="mt-2">Nenhum passageiro encontrado.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if passageiros.pages > 1 %}
    {% set filter_args = {'cliente_id': request.args.get('cliente_id', ''), 'turno_id': request.args.get('turno_id', ''), 'busca': request.args.get('busca', ''), 'vinculo': request.args.get('vinculo', ''), 'geocode': request.args.get('geocode', '')} %}
    <div class="card-footer">
        <nav>
            <ul class="pagination mb-0 justify-content-center">
                {% if passageiros.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('passageiros.lista', page=passageiros.prev_num, **filter_args) }}">
                        Anterior
                    </a>
                </li>
                {% endif %}
                <li class="page-item disabled">
                    <span class="page-link">Página {{ passageiros.page }} de {{ passageiros.pages }}
                        ({{ passageiros.total }} passageiros)
                    </span>
                </li>
                {% if passageiros.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('passageiros.lista', page=passageiros.next_num, **filter_args) }}">
                        Próxima
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('filtro_cliente').addEventListener('change', function() {
    var clienteId = this.value;
    var turnoSelect = document.getElementById('filtro_turno');
    turnoSelect.innerHTML = '<option value="">Todos</option>';
    if (!clienteId) return;

    fetch('/passageiros/api/turnos?cliente_id=' + clienteId)
        .then(function(r) { return r.json(); })
        .then(function(turnos) {
            turnos.forEach(function(t) {
                var opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.nome + ' (' + t.horario + ')';
                turnoSelect.appendChild(opt);
            });
        });
});
</script>
{% endblock %}
