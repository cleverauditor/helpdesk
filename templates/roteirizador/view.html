{% extends 'base.html' %}
{% block title %}{{ rot.nome }} - Roteirizador{% endblock %}

{% block extra_css %}
<style>
.stepper { display: flex; justify-content: space-between; margin-bottom: 2rem; }
.step { flex: 1; text-align: center; position: relative; }
.step::after { content: ''; position: absolute; top: 18px; left: 50%; width: 100%; height: 3px; background: #dee2e6; z-index: 0; }
.step:last-child::after { display: none; }
.step .step-circle { width: 36px; height: 36px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85rem; position: relative; z-index: 1; background: #dee2e6; color: #6c757d; }
.step.done .step-circle { background: #198754; color: white; }
.step.active .step-circle { background: #0d6efd; color: white; box-shadow: 0 0 0 4px rgba(13,110,253,0.25); }
.step.done::after { background: #198754; }
.step .step-label { display: block; font-size: 0.78rem; margin-top: 6px; color: #6c757d; }
.step.done .step-label, .step.active .step-label { color: #212529; font-weight: 600; }
#map { height: calc(100vh - 200px); min-height: 500px; border-radius: 8px; background: #e9ecef; }
.stat-card { text-align: center; padding: 1rem; }
.stat-card .stat-value { font-size: 2rem; font-weight: 800; color: #20c997; }
.stat-card .stat-label { font-size: 0.82rem; color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('roteirizador.lista') }}">Roteirizador</a></li>
            <li class="breadcrumb-item active">{{ rot.nome }}</li>
        </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-map"></i> {{ rot.nome }}</h2>
        <div>
            {% if rot.status in ['otimizado', 'finalizado'] %}
            <form method="POST" action="{{ url_for('roteirizador.exportar_kml', id=rot.id) }}" class="d-inline">
                <button class="btn btn-outline-success"><i class="bi bi-download"></i> Exportar KML</button>
            </form>
            <form method="POST" action="{{ url_for('roteirizador.exportar_csv', id=rot.id) }}" class="d-inline">
                <button class="btn btn-outline-primary"><i class="bi bi-filetype-csv"></i> Exportar CSV</button>
            </form>
            <a href="{{ url_for('roteirizador.relatorio', id=rot.id) }}" class="btn btn-success">
                <i class="bi bi-file-earmark-text"></i> Relatório
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stepper de progresso -->
{% set steps = ['rascunho', 'geocodificado', 'clusterizado', 'otimizado', 'finalizado'] %}
{% set step_labels = ['Importar', 'Geocodificar', 'Clusterizar', 'Otimizar', 'Finalizado'] %}
{% set step_icons = ['1', '2', '3', '4', '5'] %}
{% set current_idx = steps.index(rot.status) if rot.status in steps else 0 %}

<div class="stepper">
    {% for i in range(steps|length) %}
    <div class="step {% if i <= current_idx %}done{% elif i == current_idx + 1 and rot.status != 'finalizado' %}active{% endif %}">
        <span class="step-circle">
            {% if i <= current_idx %}<i class="bi bi-check"></i>{% else %}{{ step_icons[i] }}{% endif %}
        </span>
        <span class="step-label">{{ step_labels[i] }}</span>
    </div>
    {% endfor %}
</div>

<!-- Mapa em largura total -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Mapa</h5>
        {% if rot.status == 'otimizado' and roteiros %}
        <a href="{{ url_for('roteirizador.editar_mapa', id=rot.id) }}" class="btn btn-sm btn-dark">
            <i class="bi bi-pencil-square"></i> Editar Trajeto
        </a>
        {% endif %}
    </div>
    <div class="card-body p-0">
        <div id="map"></div>
    </div>
    {% if rotas_existentes %}
    <div class="card-footer">
        <small>
            <span class="badge" style="background:#20c997;">&#9644;</span> Rotas novas (atual)
            &nbsp;&nbsp;
            <span class="badge" style="background:#6c757d;">&#9644;</span> Rotas existentes ({{ rotas_existentes|length }} finalizadas)
        </small>
    </div>
    {% endif %}
</div>

<div class="row">
    <!-- Coluna principal -->
    <div class="col-md-8">

        <!-- Ações por etapa -->
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-lightning"></i> Ações</h5></div>
            <div class="card-body">
                {% if rot.status == 'rascunho' %}
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Próximo passo: Geocodificar</h6>
                    <p class="mb-2">Converta os endereços dos passageiros em coordenadas geográficas.</p>
                    <form method="POST" action="{{ url_for('roteirizador.geocodificar', id=rot.id) }}">
                        <button class="btn btn-primary"><i class="bi bi-geo-alt-fill"></i> Geocodificar Endereços ({{ total_pendente }} pendentes)</button>
                    </form>
                </div>

                {% elif rot.status == 'geocodificado' %}
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Próximo passo: Clusterizar</h6>
                    <p class="mb-2">Agrupe os passageiros em pontos de parada (raio: {{ rot.distancia_maxima_caminhada }}m).</p>
                    {% if total_falha > 0 %}
                    <div class="alert alert-warning mb-2">
                        <i class="bi bi-exclamation-triangle"></i> {{ total_falha }} endereço(s) com falha na geocodificação.
                        <a href="{{ url_for('roteirizador.listar_passageiros', id=rot.id) }}">Corrigir manualmente</a>
                    </div>
                    {% endif %}
                    <form method="POST" action="{{ url_for('roteirizador.clusterizar', id=rot.id) }}">
                        <button class="btn btn-dark"><i class="bi bi-diagram-3"></i> Clusterizar Passageiros</button>
                    </form>
                </div>

                {% elif rot.status == 'clusterizado' %}
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Próximo passo: Otimizar</h6>
                    <p class="mb-2">Calcule a melhor rota e horários para cada ponto de parada.</p>
                    <form method="POST" action="{{ url_for('roteirizador.otimizar', id=rot.id) }}">
                        <button class="btn btn-success"><i class="bi bi-graph-up"></i> Otimizar Rota</button>
                    </form>
                </div>

                {% elif rot.status == 'otimizado' %}
                <div class="alert alert-success d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0"><i class="bi bi-check-circle"></i> Rota otimizada com sucesso!</h6>
                        <small class="text-muted">Exporte o KML, gere o relatório, recalcule ou finalize.</small>
                    </div>
                    <form method="POST" action="{{ url_for('roteirizador.finalizar', id=rot.id) }}" class="ms-3">
                        <button class="btn btn-success" onclick="return confirm('Finalizar esta roteirização?');">
                            <i class="bi bi-check2-all"></i> Finalizar
                        </button>
                    </form>
                </div>

                <!-- Recalcular -->
                <div class="card mt-3">
                    <div class="card-header"><h6 class="mb-0"><i class="bi bi-arrow-clockwise"></i> Recalcular com novos parâmetros</h6></div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('roteirizador.recalcular', id=rot.id) }}">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Dist. Caminhada (m)</label>
                                    <input type="number" name="distancia_maxima_caminhada" class="form-control" value="{{ rot.distancia_maxima_caminhada }}" min="50" step="50">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Tempo Máx. (min)</label>
                                    <input type="number" name="tempo_maximo_viagem" class="form-control" value="{{ rot.tempo_maximo_viagem }}" min="15">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Horário Chegada</label>
                                    <input type="time" name="horario_chegada" class="form-control" value="{{ rot.horario_chegada.strftime('%H:%M') }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Capacidade</label>
                                    <input type="number" name="capacidade_veiculo" class="form-control" value="{{ rot.capacidade_veiculo }}" min="1">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-dark mt-3" onclick="return confirm('Deseja fazer uma simulação com os novos parâmetros?')"><i class="bi bi-arrow-clockwise"></i> Recalcular</button>
                        </form>
                    </div>
                </div>

                <!-- Gerar Retorno -->
                <div class="card mt-3">
                    <div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="bi bi-arrow-return-left"></i> Gerar Retorno (Volta)</h6></div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('roteirizador.gerar_retorno', id=rot.id) }}">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label">Horário de Saída do Destino</label>
                                    <input type="time" name="horario_saida_retorno" class="form-control" value="{{ rot.horario_saida_retorno.strftime('%H:%M') if rot.horario_saida_retorno else '17:00' }}" required>
                                </div>
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-return-left"></i> Gerar Retorno</button>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">Usa as mesmas paradas da ida, re-otimiza a ordem e calcula horários progressivamente.</small>
                        </form>
                    </div>
                </div>

                {% elif rot.status == 'finalizado' %}
                <div class="alert alert-primary d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0"><i class="bi bi-check2-all"></i> Roteirização finalizada</h6>
                        <small class="text-muted">Exporte o KML ou relatório. Para editar, reabra a roteirização.</small>
                    </div>
                    <form method="POST" action="{{ url_for('roteirizador.reabrir', id=rot.id) }}" class="ms-3">
                        <button class="btn btn-dark" onclick="return confirm('Reabrir para edição?');">
                            <i class="bi bi-arrow-counterclockwise"></i> Reabrir
                        </button>
                    </form>
                </div>

                <!-- Gerar Retorno (finalizado) -->
                <div class="card mt-3">
                    <div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="bi bi-arrow-return-left"></i> Gerar Retorno (Volta)</h6></div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('roteirizador.gerar_retorno', id=rot.id) }}">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label">Horário de Saída do Destino</label>
                                    <input type="time" name="horario_saida_retorno" class="form-control" value="{{ rot.horario_saida_retorno.strftime('%H:%M') if rot.horario_saida_retorno else '17:00' }}" required>
                                </div>
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-return-left"></i> Gerar Retorno</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Tabela de paradas por rota -->
        {% for roteiro in roteiros %}
        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between">
                <h5 class="mb-0"><i class="bi bi-signpost-2"></i> {{ roteiro.nome }}</h5>
                <div>
                    <span class="badge bg-light text-dark">{{ roteiro.distancia_km or '-' }} km</span>
                    <span class="badge bg-light text-dark">{{ roteiro.duracao_minutos or '-' }} min</span>
                    <span class="badge bg-light text-dark">{{ roteiro.total_passageiros or 0 }} passageiros</span>
                    {% if roteiro.horario_saida %}<span class="badge bg-warning text-dark">Saída: {{ roteiro.horario_saida.strftime('%H:%M') }}</span>{% endif %}
                    {% set ns = namespace(veiculo_recomendado=none) %}
                    {% for tv in tipos_veiculo %}
                        {% if not ns.veiculo_recomendado and tv.capacidade >= (roteiro.total_passageiros or 0) %}
                            {% set ns.veiculo_recomendado = tv %}
                        {% endif %}
                    {% endfor %}
                    {% if ns.veiculo_recomendado %}
                    <span class="badge bg-info text-dark"><i class="bi bi-truck"></i> {{ ns.veiculo_recomendado.nome }} ({{ ns.veiculo_recomendado.capacidade }} lug.)</span>
                    {% elif tipos_veiculo %}
                    <span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> Excede capacidade</span>
                    {% endif %}
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Parada</th>
                            <th>Endereço Referência</th>
                            <th class="text-center">Passageiros</th>
                            <th class="text-center">Chegada</th>
                            <th class="text-center">Partida</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in paradas %}
                        {% if p.roteiro_id == roteiro.id %}
                        <tr>
                            <td><span class="badge bg-primary">{{ p.ordem or '-' }}</span></td>
                            <td><strong>{{ p.nome }}</strong></td>
                            <td class="text-truncate" style="max-width: 250px;" title="{{ p.endereco_referencia }}">{{ p.endereco_referencia or '-' }}</td>
                            <td class="text-center">{{ p.total_passageiros }}</td>
                            <td class="text-center">{{ p.horario_chegada.strftime('%H:%M') if p.horario_chegada else '-' }}</td>
                            <td class="text-center">{{ p.horario_partida.strftime('%H:%M') if p.horario_partida else '-' }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        <!-- Tabela de paradas por rota (VOLTA) -->
        {% if roteiros_volta %}
        <h4 class="mt-4 mb-3"><i class="bi bi-arrow-return-left"></i> Rotas de Retorno</h4>
        {% for roteiro in roteiros_volta %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between">
                <h5 class="mb-0"><i class="bi bi-signpost-2"></i> {{ roteiro.nome }}</h5>
                <div>
                    <span class="badge bg-light text-dark">{{ roteiro.distancia_km or '-' }} km</span>
                    <span class="badge bg-light text-dark">{{ roteiro.duracao_minutos or '-' }} min</span>
                    <span class="badge bg-light text-dark">{{ roteiro.total_passageiros or 0 }} passageiros</span>
                    {% if roteiro.horario_saida %}<span class="badge bg-warning text-dark">Saída: {{ roteiro.horario_saida.strftime('%H:%M') }}</span>{% endif %}
                    {% set ns = namespace(veiculo_recomendado=none) %}
                    {% for tv in tipos_veiculo %}
                        {% if not ns.veiculo_recomendado and tv.capacidade >= (roteiro.total_passageiros or 0) %}
                            {% set ns.veiculo_recomendado = tv %}
                        {% endif %}
                    {% endfor %}
                    {% if ns.veiculo_recomendado %}
                    <span class="badge bg-info text-dark"><i class="bi bi-truck"></i> {{ ns.veiculo_recomendado.nome }} ({{ ns.veiculo_recomendado.capacidade }} lug.)</span>
                    {% elif tipos_veiculo %}
                    <span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> Excede capacidade</span>
                    {% endif %}
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Parada</th>
                            <th>Endereço Referência</th>
                            <th class="text-center">Passageiros</th>
                            <th class="text-center">Chegada</th>
                            <th class="text-center">Partida</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-primary">
                            <td class="text-center"><i class="bi bi-building text-primary"></i></td>
                            <td colspan="2"><strong>SAÍDA: {{ rot.destino_endereco }}</strong></td>
                            <td></td>
                            <td class="text-center"><strong>{{ rot.horario_saida_retorno.strftime('%H:%M') if rot.horario_saida_retorno else '-' }}</strong></td>
                            <td class="text-center"><strong>{{ rot.horario_saida_retorno.strftime('%H:%M') if rot.horario_saida_retorno else '-' }}</strong></td>
                        </tr>
                        {% for p in paradas_volta %}
                        {% if p.roteiro_id == roteiro.id %}
                        <tr>
                            <td><span class="badge bg-primary">{{ p.ordem or '-' }}</span></td>
                            <td><strong>{{ p.nome }}</strong></td>
                            <td class="text-truncate" style="max-width: 250px;" title="{{ p.endereco_referencia }}">{{ p.endereco_referencia or '-' }}</td>
                            <td class="text-center">{{ p.total_passageiros }}</td>
                            <td class="text-center">{{ p.horario_chegada.strftime('%H:%M') if p.horario_chegada else '-' }}</td>
                            <td class="text-center">{{ p.horario_partida.strftime('%H:%M') if p.horario_partida else '-' }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Detalhamento por Rota (Ida) -->
        {% if roteiros %}
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-signpost-split"></i> Rotas (Ida)</h5></div>
            <div class="list-group list-group-flush">
                {% for r in roteiros %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge rounded-pill me-2" style="background-color: {{ ['#E82000','#0d6efd','#198754','#6f42c1','#fd7e14','#dc3545'][loop.index0 % 6] }};">&nbsp;&nbsp;</span>
                            <strong>{{ r.nome }}</strong>
                        </div>
                    </div>
                    <div class="mt-1 ms-4">
                        <small class="text-muted">
                            <i class="bi bi-speedometer2"></i> {{ r.distancia_km or '-' }} km
                            &middot; <i class="bi bi-clock"></i> {{ r.duracao_minutos or '-' }} min
                            &middot; <i class="bi bi-people-fill"></i> {{ r.total_passageiros or 0 }} passageiros
                        </small>
                        {% if r.horario_saida %}
                        <br><small class="text-muted"><i class="bi bi-box-arrow-right"></i> Saída: <strong>{{ r.horario_saida.strftime('%H:%M') }}</strong></small>
                        {% endif %}
                        {% set ns = namespace(veiculo_rec=none) %}
                        {% for tv in tipos_veiculo %}
                            {% if not ns.veiculo_rec and tv.capacidade >= (r.total_passageiros or 0) %}
                                {% set ns.veiculo_rec = tv %}
                            {% endif %}
                        {% endfor %}
                        {% if ns.veiculo_rec %}
                        <br><small class="text-info"><i class="bi bi-truck"></i> <strong>{{ ns.veiculo_rec.nome }}</strong> ({{ ns.veiculo_rec.capacidade }} lugares)</small>
                        {% elif tipos_veiculo %}
                        <br><small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Excede capacidade</small>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Rotas de Volta (sidebar) -->
        {% if roteiros_volta %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="bi bi-arrow-return-left"></i> Rotas (Volta)</h5></div>
            <div class="list-group list-group-flush">
                {% for r in roteiros_volta %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge rounded-pill bg-primary me-2">&nbsp;&nbsp;</span>
                            <strong>{{ r.nome }}</strong>
                        </div>
                    </div>
                    <div class="mt-1 ms-4">
                        <small class="text-muted">
                            <i class="bi bi-speedometer2"></i> {{ r.distancia_km or '-' }} km
                            &middot; <i class="bi bi-clock"></i> {{ r.duracao_minutos or '-' }} min
                            &middot; <i class="bi bi-people-fill"></i> {{ r.total_passageiros or 0 }} passageiros
                        </small>
                        {% if r.horario_saida %}
                        <br><small class="text-muted"><i class="bi bi-box-arrow-right"></i> Saída: <strong>{{ r.horario_saida.strftime('%H:%M') }}</strong></small>
                        {% endif %}
                        {% set ns = namespace(veiculo_rec=none) %}
                        {% for tv in tipos_veiculo %}
                            {% if not ns.veiculo_rec and tv.capacidade >= (r.total_passageiros or 0) %}
                                {% set ns.veiculo_rec = tv %}
                            {% endif %}
                        {% endfor %}
                        {% if ns.veiculo_rec %}
                        <br><small class="text-info"><i class="bi bi-truck"></i> <strong>{{ ns.veiculo_rec.nome }}</strong> ({{ ns.veiculo_rec.capacidade }} lugares)</small>
                        {% elif tipos_veiculo %}
                        <br><small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Excede capacidade</small>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Resumo Geral -->
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-bar-chart"></i> Resumo</h5></div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value">{{ rot.total_passageiros or 0 }}</div>
                            <div class="stat-label">Passageiros</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value">{{ rot.total_paradas or 0 }}</div>
                            <div class="stat-label">Paradas</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value">{{ rot.total_rotas or 0 }}</div>
                            <div class="stat-label">Veículos</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value">{{ '%.1f'|format(rot.distancia_total_km) if rot.distancia_total_km else '-' }}</div>
                            <div class="stat-label">Km Total</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parâmetros -->
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-sliders"></i> Parâmetros</h5></div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr><td class="text-muted">Destino</td><td><strong>{{ rot.destino_endereco }}</strong></td></tr>
                    <tr><td class="text-muted">Chegada</td><td><strong>{{ rot.horario_chegada.strftime('%H:%M') }}</strong></td></tr>
                    <tr><td class="text-muted">Dist. Caminhada</td><td>{{ rot.distancia_maxima_caminhada }}m</td></tr>
                    <tr><td class="text-muted">Tempo Máx.</td><td>{{ rot.tempo_maximo_viagem }} min</td></tr>
                    <tr><td class="text-muted">Capacidade</td><td>{{ rot.capacidade_veiculo }} lugares</td></tr>
                    {% if rot.duracao_total_minutos %}
                    <tr><td class="text-muted">Maior Rota</td><td><strong>{{ rot.duracao_total_minutos }} min</strong></td></tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Simulações -->
        {% if simulacoes %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-collection"></i> Simulações</h5>
                <a href="{{ url_for('roteirizador.simulacoes', id=rot.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-table"></i> Comparar
                </a>
            </div>
            <div class="list-group list-group-flush">
                {% for sim in simulacoes %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>{{ sim.nome }}</strong>
                            <br><small class="text-muted">
                                {{ sim.total_rotas or 0 }} rotas &middot;
                                {{ '%.1f'|format(sim.distancia_total_km) if sim.distancia_total_km else '-' }} km &middot;
                                {{ sim.duracao_total_minutos or '-' }} min
                            </small>
                            <br><small class="text-muted">{{ sim.criado_em.strftime('%d/%m %H:%M') }}</small>
                        </div>
                        <div class="d-flex gap-1">
                            <form method="POST" action="{{ url_for('roteirizador.aplicar_simulacao', id=rot.id, sim_id=sim.id) }}">
                                <button class="btn btn-sm btn-outline-success" title="Aplicar" onclick="return confirm('Aplicar esta simulação? O estado atual será salvo.')">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('roteirizador.excluir_simulacao', id=rot.id, sim_id=sim.id) }}">
                                <button class="btn btn-sm btn-outline-danger" title="Excluir" onclick="return confirm('Excluir esta simulação?')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Links rápidos -->
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-link-45deg"></i> Ações Rápidas</h5></div>
            <div class="card-body d-grid gap-2">
                <a href="{{ url_for('roteirizador.listar_passageiros', id=rot.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-people"></i> Ver Passageiros ({{ rot.total_passageiros or 0 }})
                </a>
                {% if rot.status in ['otimizado', 'finalizado'] %}
                {% if simulacoes %}
                <div class="btn-group w-100">
                    <a href="{{ url_for('roteirizador.relatorio', id=rot.id) }}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-file-earmark-text"></i> Relatório Atual
                    </a>
                    <button type="button" class="btn btn-outline-success btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
                    <ul class="dropdown-menu">
                        <li><h6 class="dropdown-header">Simulações</h6></li>
                        {% for sim in simulacoes %}
                        <li><a class="dropdown-item" href="{{ url_for('roteirizador.relatorio_simulacao', id=rot.id, sim_id=sim.id) }}">{{ sim.nome }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
                {% else %}
                <a href="{{ url_for('roteirizador.relatorio', id=rot.id) }}" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-file-earmark-text"></i> Ver Relatório Completo
                </a>
                {% endif %}
                {% endif %}
                <form method="POST" action="{{ url_for('roteirizador.excluir', id=rot.id) }}" onsubmit="return confirm('Excluir esta roteirização?');">
                    <button class="btn btn-outline-danger btn-sm w-100"><i class="bi bi-trash"></i> Excluir</button>
                </form>
            </div>
        </div>

        <!-- Info -->
        <div class="card">
            <div class="card-body">
                <small class="text-muted">
                    <i class="bi bi-person"></i> Criado por: {{ rot.usuario.nome if rot.usuario else '-' }}<br>
                    <i class="bi bi-calendar"></i> {{ rot.criado_em.strftime('%d/%m/%Y %H:%M') if rot.criado_em else '-' }}<br>
                    {% if rot.cliente %}
                    <i class="bi bi-building"></i> Cliente: {{ rot.cliente.nome }}
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=geometry&callback=initMap" async defer></script>
<script>
var map, bounds;
var staticPolylines = [];
var stopMarkers = [];
var ROUTE_COLORS = ['#E82000', '#0d6efd', '#198754', '#6f42c1', '#fd7e14', '#dc3545'];

// SVG boneco (person icon) - Bootstrap Icons person-fill em círculo colorido
function personIcon(color) {
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="-2 -2 20 20">' +
        '<circle cx="8" cy="8" r="9" fill="' + color + '" stroke="white" stroke-width="1.5"/>' +
        '<path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" fill="white"/>' +
        '</svg>';
    return {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
        scaledSize: new google.maps.Size(28, 28),
        anchor: new google.maps.Point(14, 14)
    };
}

// SVG ponto de parada numerado com cor da rota
function stopIcon(color, numero) {
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="44" viewBox="0 0 36 44">' +
        '<path d="M18 44 C18 44 36 26 36 18 C36 8 28 0 18 0 C8 0 0 8 0 18 C0 26 18 44 18 44Z" fill="' + color + '" stroke="white" stroke-width="2"/>' +
        '<circle cx="18" cy="18" r="12" fill="white" opacity="0.9"/>' +
        '<text x="18" y="23" text-anchor="middle" font-size="14" font-weight="bold" fill="' + color + '">' + numero + '</text>' +
        '</svg>';
    return {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
        scaledSize: new google.maps.Size(32, 40),
        anchor: new google.maps.Point(16, 40)
    };
}

// Dados serializados via JSON seguro
var destinoPos = { lat: {{ rot.destino_lat|default(-19.92, true) }}, lng: {{ rot.destino_lng|default(-43.94, true) }} };

var passageirosData = [
    {% for p in passageiros %}{% if p.lat and p.lng %}
    { lat: {{ p.lat }}, lng: {{ p.lng }}, nome: {{ p.nome|tojson }}, endereco: {{ (p.endereco_formatado or p.endereco or '-')|tojson }}, bairro: {{ (p.bairro or '')|tojson }}, cidade: {{ (p.cidade or '')|tojson }}, telefone: {{ (p.telefone or '')|tojson }}, status: {{ p.geocode_status|tojson }}, roteiroId: {{ p.parada.roteiro_id if p.parada and p.parada.roteiro_id else 'null' }}, parada: {{ (p.parada.nome if p.parada else '-')|tojson }}, distCaminhada: {{ p.distancia_ate_parada|default(0, true) }}, tempoVeiculo: {{ p.tempo_no_veiculo|default(0, true) }} },
    {% endif %}{% endfor %}
];

var paradasData = [
    {% for p in paradas %}
    { id: {{ p.id }}, lat: {{ p.lat }}, lng: {{ p.lng }}, nome: {{ p.nome|tojson }}, ordem: {{ p.ordem|default(0, true)|tojson }}, total: {{ p.total_passageiros }}, endereco: {{ (p.endereco_referencia or '-')|tojson }}, chegada: {{ (p.horario_chegada.strftime('%H:%M') if p.horario_chegada else '-')|tojson }}, roteiroId: {{ p.roteiro_id|default('null', true) }} },
    {% endfor %}
];

var roteirosPolylines = [
    {% for r in roteiros %}{% if r.polyline_encoded %}
    { id: {{ r.id }}, encoded: {{ r.polyline_encoded|tojson }} },
    {% endif %}{% endfor %}
];

var roteirosData = [
    {% for r in roteiros %}
    { id: {{ r.id }}, nome: {{ r.nome|tojson }} },
    {% endfor %}
];

// Dados de volta
var paradasVoltaData = [
    {% for p in paradas_volta %}
    { id: {{ p.id }}, lat: {{ p.lat }}, lng: {{ p.lng }}, nome: {{ p.nome|tojson }}, ordem: {{ p.ordem|default(0, true)|tojson }}, total: {{ p.total_passageiros }}, endereco: {{ (p.endereco_referencia or '-')|tojson }}, chegada: {{ (p.horario_chegada.strftime('%H:%M') if p.horario_chegada else '-')|tojson }}, roteiroId: {{ p.roteiro_id|default('null', true) }} },
    {% endfor %}
];

var roteirosVoltaPolylines = [
    {% for r in roteiros_volta %}{% if r.polyline_encoded %}
    { id: {{ r.id }}, encoded: {{ r.polyline_encoded|tojson }} },
    {% endif %}{% endfor %}
];

var roteirosVoltaData = [
    {% for r in roteiros_volta %}
    { id: {{ r.id }}, nome: {{ r.nome|tojson }} },
    {% endfor %}
];

// Rotas existentes (finalizadas do mesmo cliente+turno)
var rotasExistentes = [
    {% for r in rotas_existentes %}
    { nome: {{ r.nome|tojson }}, polyline: {{ r.polyline|tojson }} },
    {% endfor %}
];

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: destinoPos,
        mapTypeControl: true,
        streetViewControl: false
    });

    bounds = new google.maps.LatLngBounds();
    bounds.extend(destinoPos);

    // Destino (ícone de prédio/fábrica)
    var destinoSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="48" viewBox="0 0 40 48">' +
        '<path d="M20 48 C20 48 40 30 40 20 C40 9 31 0 20 0 C9 0 0 9 0 20 C0 30 20 48 20 48Z" fill="#dc3545" stroke="white" stroke-width="2"/>' +
        '<rect x="11" y="9" width="18" height="22" rx="1" fill="white"/>' +
        '<rect x="14" y="12" width="4" height="4" rx="0.5" fill="#dc3545"/>' +
        '<rect x="22" y="12" width="4" height="4" rx="0.5" fill="#dc3545"/>' +
        '<rect x="14" y="19" width="4" height="4" rx="0.5" fill="#dc3545"/>' +
        '<rect x="22" y="19" width="4" height="4" rx="0.5" fill="#dc3545"/>' +
        '<rect x="17" y="25" width="6" height="6" fill="#dc3545"/>' +
        '</svg>';
    new google.maps.Marker({
        position: destinoPos,
        map: map,
        icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(destinoSvg),
            scaledSize: new google.maps.Size(36, 44),
            anchor: new google.maps.Point(18, 44)
        },
        title: 'Destino: ' + {{ rot.destino_endereco|tojson }},
        zIndex: 1000
    });

    // Mapa de roteiro ID -> cor da rota
    var roteiroColorMap = {};
    roteirosData.forEach(function(r, idx) {
        roteiroColorMap[r.id] = ROUTE_COLORS[idx % ROUTE_COLORS.length];
    });

    // Passageiros (boneco) - cor igual à linha da rota
    passageirosData.forEach(function(p) {
        var color;
        if (p.status !== 'sucesso' && p.status !== 'manual') {
            color = '#dc3545';
        } else if (p.roteiroId && roteiroColorMap[p.roteiroId]) {
            color = roteiroColorMap[p.roteiroId];
        } else {
            color = '#6c757d';
        }
        var marker = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map: map,
            icon: personIcon(color),
            title: p.nome,
            zIndex: 10
        });
        var info = '<div style="min-width:200px">' +
            '<strong style="font-size:1.05em">' + p.nome + '</strong><br>' +
            '<small class="text-muted">' + p.endereco + '</small>';
        if (p.bairro) info += '<br><small>' + p.bairro + (p.cidade ? ' - ' + p.cidade : '') + '</small>';
        if (p.telefone) info += '<br><small><i class="bi bi-telephone"></i> ' + p.telefone + '</small>';
        info += '<hr style="margin:6px 0">';
        info += '<small><b>Parada:</b> ' + p.parada + '</small><br>';
        info += '<small><b>Caminhada:</b> ' + Math.round(p.distCaminhada) + 'm</small>';
        if (p.tempoVeiculo > 0) info += '<br><small><b>Tempo no veículo:</b> ' + p.tempoVeiculo + ' min</small>';
        info += '</div>';
        var infoWindow = new google.maps.InfoWindow({ content: info });
        marker.addListener('click', function() { infoWindow.open(map, marker); });
        bounds.extend({ lat: p.lat, lng: p.lng });
    });

    // Paradas (marcadores numerados com cor da rota)
    paradasData.forEach(function(p) {
        var color = (p.roteiroId && roteiroColorMap[p.roteiroId]) ? roteiroColorMap[p.roteiroId] : '#6c757d';
        var marker = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map: map,
            icon: stopIcon(color, p.ordem),
            title: p.nome + ' - ' + p.total + ' passageiros',
            zIndex: 100
        });
        marker._paradaId = p.id;
        stopMarkers.push(marker);
        bounds.extend({ lat: p.lat, lng: p.lng });

        var infoWindow = new google.maps.InfoWindow({
            content: '<strong>' + p.nome + '</strong><br>' + p.endereco + '<br>Passageiros: ' + p.total + '<br>Chegada: ' + p.chegada
        });
        marker.addListener('click', function() { infoWindow.open(map, marker); });
    });

    // Polylines das rotas
    roteirosPolylines.forEach(function(r, idx) {
        try {
            var decoded = google.maps.geometry.encoding.decodePath(r.encoded);
            var poly = new google.maps.Polyline({
                path: decoded,
                geodesic: true,
                strokeColor: ROUTE_COLORS[idx % ROUTE_COLORS.length],
                strokeOpacity: 0.85,
                strokeWeight: 5,
                map: map
            });
            poly._roteiroId = r.id;
            staticPolylines.push(poly);
        } catch(e) {
            console.error('Erro ao decodificar polyline da rota ' + r.id + ':', e);
        }
    });

    // === ROTAS DE VOLTA ===
    var voltaColorMap = {};
    roteirosVoltaData.forEach(function(r, idx) {
        voltaColorMap[r.id] = ROUTE_COLORS[idx % ROUTE_COLORS.length];
    });

    // Paradas de volta (marcadores com borda tracejada / "V" prefix)
    paradasVoltaData.forEach(function(p) {
        var color = (p.roteiroId && voltaColorMap[p.roteiroId]) ? voltaColorMap[p.roteiroId] : '#6c757d';
        var marker = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map: map,
            icon: stopIcon(color, 'V' + p.ordem),
            title: p.nome + ' (Volta) - ' + p.total + ' passageiros',
            zIndex: 90
        });
        bounds.extend({ lat: p.lat, lng: p.lng });
        var infoWindow = new google.maps.InfoWindow({
            content: '<strong>' + p.nome + '</strong> <span class="badge bg-primary">Volta</span><br>' + p.endereco + '<br>Passageiros: ' + p.total + '<br>Chegada: ' + p.chegada
        });
        marker.addListener('click', function() { infoWindow.open(map, marker); });
    });

    // Polylines de volta (tracejadas)
    roteirosVoltaPolylines.forEach(function(r, idx) {
        try {
            var decoded = google.maps.geometry.encoding.decodePath(r.encoded);
            var lineSymbol = { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 3 };
            new google.maps.Polyline({
                path: decoded,
                geodesic: true,
                strokeColor: ROUTE_COLORS[idx % ROUTE_COLORS.length],
                strokeOpacity: 0,
                strokeWeight: 0,
                icons: [{ icon: lineSymbol, offset: '0', repeat: '15px' }],
                map: map
            });
        } catch(e) {
            console.error('Erro polyline volta:', e);
        }
    });

    // Rotas existentes (finalizadas) em cinza
    rotasExistentes.forEach(function(r) {
        try {
            var decoded = google.maps.geometry.encoding.decodePath(r.polyline);
            new google.maps.Polyline({
                path: decoded,
                geodesic: true,
                strokeColor: '#6c757d',
                strokeOpacity: 0.5,
                strokeWeight: 4,
                map: map,
                zIndex: 1
            });
        } catch(e) {
            console.error('Erro polyline existente:', e);
        }
    });

    if (bounds.getNorthEast().equals(bounds.getSouthWest())) {
        map.setZoom(14);
    } else {
        map.fitBounds(bounds, 50);
    }
}

</script>
{% endblock %}
