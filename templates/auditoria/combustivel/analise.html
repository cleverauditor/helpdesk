{% extends 'base.html' %}

{% block title %}Análise de Combustível - {{ analise.nome_arquivo }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-fuel-pump"></i> Análise de Combustível</h2>
    <div>
        <form method="POST" action="{{ url_for('auditoria.combustivel_exportar', id=analise.id) }}" style="display:inline">
            <input type="hidden" name="apenas_alertas" value="0">
            <button type="submit" class="btn btn-outline-success me-1" title="Exportar todos">
                <i class="bi bi-download"></i> CSV Completo
            </button>
        </form>
        <form method="POST" action="{{ url_for('auditoria.combustivel_exportar', id=analise.id) }}" style="display:inline">
            <input type="hidden" name="apenas_alertas" value="1">
            <button type="submit" class="btn btn-outline-warning me-1" title="Exportar alertas">
                <i class="bi bi-download"></i> CSV Alertas
            </button>
        </form>
        <form method="POST" action="{{ url_for('auditoria.combustivel_reanalisar', id=analise.id) }}" style="display:inline">
            <button type="submit" class="btn btn-outline-info me-1" title="Reanalisar com médias padrão atuais">
                <i class="bi bi-arrow-repeat"></i> Reanalisar
            </button>
        </form>
        <a href="{{ url_for('auditoria.combustivel_medias_padrao') }}" class="btn btn-outline-dark me-1">
            <i class="bi bi-speedometer"></i> Médias Padrão
        </a>
        <a href="{{ url_for('auditoria.combustivel') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<!-- Info do arquivo -->
<div class="alert alert-info mb-4">
    <strong>{{ analise.nome_arquivo }}</strong>
    {% if analise.empresa %} | {{ analise.empresa }}{% endif %}
    {% if analise.periodo_inicio and analise.periodo_fim %}
    | Período: {{ analise.periodo_inicio.strftime('%d/%m/%Y') }} a {{ analise.periodo_fim.strftime('%d/%m/%Y') }}
    {% endif %}
    | Importado em {{ analise.criado_em.strftime('%d/%m/%Y %H:%M') }} por {{ analise.usuario.nome }}
</div>

<!-- Cards Resumo -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card card-stat border-primary">
            <div class="card-body text-center">
                <h4 class="card-title text-primary mb-0">{{ analise.total_registros }}</h4>
                <small class="text-muted">Abastecimentos</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stat border-info">
            <div class="card-body text-center">
                <h4 class="card-title text-info mb-0">{{ analise.total_veiculos }}</h4>
                <small class="text-muted">Veículos</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stat border-secondary">
            <div class="card-body text-center">
                <h4 class="card-title text-secondary mb-0">{{ "{:,.0f}".format(analise.total_litros or 0).replace(",", ".") }}</h4>
                <small class="text-muted">Litros</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stat border-success">
            <div class="card-body text-center">
                <h4 class="card-title text-success mb-0">{{ "{:,.0f}".format(analise.total_km or 0).replace(",", ".") }}</h4>
                <small class="text-muted">Km Total</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stat border-primary">
            <div class="card-body text-center">
                <h4 class="card-title text-primary mb-0">{{ "%.2f"|format(analise.media_kml or 0) }}</h4>
                <small class="text-muted">Km/L Médio</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stat border-danger">
            <div class="card-body text-center">
                <h4 class="card-title text-danger mb-0">{{ analise.total_alertas }}</h4>
                <small class="text-muted">Alertas</small>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Tabela Km/L por Modelo -->
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-truck"></i> Média Km/L por Modelo de Veículo
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Modelo</th>
                                <th class="text-center">Veíc.</th>
                                <th class="text-center">Abast.</th>
                                <th class="text-end">Litros</th>
                                <th class="text-end">Km</th>
                                <th class="text-end">Km/L Médio</th>
                                <th class="text-end text-primary">Ref. Padrão</th>
                                <th class="text-end">Faixa Aceitável</th>
                                <th class="text-center">Alertas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for modelo, s in modelos.items() %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('auditoria.combustivel_analise', id=analise.id, filtro='todos', modelo=modelo) }}">
                                        {{ modelo }}
                                    </a>
                                    {% if s.categoria %}
                                    <br><small class="text-muted">{{ s.categoria }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ s.total_veiculos }}</td>
                                <td class="text-center">{{ s.total_registros }}</td>
                                <td class="text-end">{{ "{:,.1f}".format(s.total_litros).replace(",", ".") }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(s.total_km).replace(",", ".") }}</td>
                                <td class="text-end">
                                    <strong>{{ "%.2f"|format(s.media_kml) }}</strong>
                                    {% if s.ref_kml %}
                                        {% set desvio = ((s.media_kml - s.ref_kml) / s.ref_kml * 100) %}
                                        {% if desvio < -15 %}
                                        <br><small class="text-danger">{{ "%.0f"|format(desvio) }}%</small>
                                        {% elif desvio > 15 %}
                                        <br><small class="text-warning">+{{ "%.0f"|format(desvio) }}%</small>
                                        {% else %}
                                        <br><small class="text-success">{{ "%+.0f"|format(desvio) }}%</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if s.ref_kml %}
                                    <strong class="text-primary">{{ "%.2f"|format(s.ref_kml) }}</strong>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if s.ref_min and s.ref_max %}
                                    <small>{{ "%.1f"|format(s.ref_min) }} - {{ "%.1f"|format(s.ref_max) }}</small>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if s.total_alertas > 0 %}
                                    <span class="badge bg-danger">{{ s.total_alertas }}</span>
                                    {% else %}
                                    <span class="text-muted">0</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico -->
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Km/L Médio por Modelo
            </div>
            <div class="card-body">
                <canvas id="chartModelos" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Visualização</label>
                <select name="filtro" class="form-select">
                    <option value="alertas" {{ 'selected' if filtro == 'alertas' }}>Apenas Alertas</option>
                    <option value="todos" {{ 'selected' if filtro == 'todos' }}>Todos os Registros</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Modelo</label>
                <select name="modelo" class="form-select">
                    <option value="">Todos os Modelos</option>
                    {% for modelo in modelos.keys() %}
                    <option value="{{ modelo }}" {{ 'selected' if modelo_filtro == modelo }}>{{ modelo }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Prefixo</label>
                <select name="prefixo" class="form-select">
                    <option value="">Todos os Prefixos</option>
                    {% for p in prefixos %}
                    <option value="{{ p }}" {{ 'selected' if prefixo_filtro == p }}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search"></i> Filtrar
                </button>
                <a href="{{ url_for('auditoria.combustivel_analise', id=analise.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tabela de Registros -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>
            <i class="bi bi-table"></i>
            {% if filtro == 'alertas' %}
            Registros com Alertas ({{ registros|length }})
            {% else %}
            Todos os Registros ({{ registros|length }} de {{ total_registros }})
            {% endif %}
        </span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0" style="font-size: 0.85rem;">
                <thead class="table-light">
                    <tr>
                        <th>Prefixo</th>
                        <th>Data</th>
                        <th>Hora</th>
                        <th>Modelo</th>
                        <th class="text-end">Litros</th>
                        <th class="text-end">Hod. Ini.</th>
                        <th class="text-end">Hod. Fin.</th>
                        <th class="text-end">Km</th>
                        <th class="text-end">Km/L</th>
                        <th>Flag</th>
                        <th>Alerta</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in registros %}
                    <tr class="{{ 'table-danger' if r.alerta and 'MUITO' in (r.tipo_alerta or '') else 'table-warning' if r.alerta else '' }}">
                        <td><strong>{{ r.prefixo }}</strong></td>
                        <td>{{ r.data.strftime('%d/%m/%Y') if r.data else '-' }}</td>
                        <td>{{ r.hora or '-' }}</td>
                        <td>{{ r.modelo or '-' }}</td>
                        <td class="text-end">{{ "%.2f"|format(r.litros or 0) }}</td>
                        <td class="text-end">{{ "{:,.0f}".format(r.hodometro_inicio or 0).replace(",", ".") }}</td>
                        <td class="text-end">{{ "{:,.0f}".format(r.hodometro_fim or 0).replace(",", ".") }}</td>
                        <td class="text-end">{{ "%.1f"|format(r.km or 0) }}</td>
                        <td class="text-end">
                            {% if r.alerta and r.tipo_alerta and ('KML' in r.tipo_alerta or 'HODOMETRO' in r.tipo_alerta or 'KM_INVALIDO' in r.tipo_alerta) %}
                            <strong class="text-danger">{{ "%.2f"|format(r.kml or 0) }}</strong>
                            {% else %}
                            {{ "%.2f"|format(r.kml or 0) }}
                            {% endif %}
                        </td>
                        <td>
                            {% if r.flag == '*' %}
                            <span class="badge bg-secondary">*</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if r.alerta %}
                            <span class="badge bg-{{ 'danger' if 'MUITO' in (r.tipo_alerta or '') or 'INVALIDO' in (r.tipo_alerta or '') or 'DECRESCENTE' in (r.tipo_alerta or '') or 'INCONSISTENTE' in (r.tipo_alerta or '') else 'warning text-dark' }}"
                                  title="{{ r.descricao_alerta }}" style="cursor: help; white-space: normal; text-align: left; max-width: 300px;">
                                {{ r.descricao_alerta }}
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" class="text-center text-muted py-4">
                            {% if filtro == 'alertas' %}
                            Nenhum alerta encontrado com os filtros selecionados.
                            {% else %}
                            Nenhum registro encontrado.
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var ctx = document.getElementById('chartModelos');
    if (!ctx) return;

    var modelos = {{ modelos | tojson }};
    var labels = [];
    var mediasKml = [];
    var refKml = [];
    var cores = [];

    for (var modelo in modelos) {
        var nome = modelo.replace(/^\d{3}-/, '');
        labels.push(nome);
        mediasKml.push(modelos[modelo].media_kml);
        refKml.push(modelos[modelo].ref_kml);

        // Colorir baseado no desvio da referência
        var ref = modelos[modelo].ref_kml;
        var media = modelos[modelo].media_kml;
        if (ref && media) {
            var desvio = ((media - ref) / ref) * 100;
            if (desvio < -15) {
                cores.push('rgba(220, 53, 69, 0.7)');  // vermelho
            } else if (desvio > 15) {
                cores.push('rgba(255, 193, 7, 0.7)');  // amarelo
            } else {
                cores.push('rgba(25, 135, 84, 0.7)');  // verde
            }
        } else {
            cores.push('rgba(0, 168, 232, 0.7)');  // azul padrão
        }
    }

    var datasets = [{
        label: 'Km/L Médio Real',
        data: mediasKml,
        backgroundColor: cores,
        borderColor: cores.map(function(c) { return c.replace('0.7', '1'); }),
        borderWidth: 1
    }];

    // Adicionar referência se houver ao menos uma cadastrada
    var temRef = refKml.some(function(v) { return v !== null; });
    if (temRef) {
        datasets.push({
            label: 'Km/L Padrão (Referência)',
            data: refKml,
            backgroundColor: 'rgba(0, 0, 0, 0)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 2,
            borderDash: [5, 5],
            type: 'bar',
            barPercentage: 0.3
        });
    }

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: temRef },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.parsed.x === null) return null;
                            return context.dataset.label + ': ' + context.parsed.x.toFixed(2) + ' Km/L';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: 'Km/L' }
                }
            }
        }
    });
});
</script>
{% endblock %}
