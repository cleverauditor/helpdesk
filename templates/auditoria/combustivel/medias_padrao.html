{% extends 'base.html' %}

{% block title %}Médias Padrão de Combustível{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-speedometer"></i> Médias Padrão Km/L por Modelo</h2>
    <a href="{{ url_for('auditoria.combustivel') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    Configure as médias de Km/L de referência por modelo de veículo. Esses valores serão usados como base para detectar inconsistências nos abastecimentos.
    Após alterar, use o botão <strong>"Reanalisar"</strong> na página da análise para aplicar os novos valores.
</div>

<!-- Formulário de cadastro -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-plus-circle"></i> Cadastrar Média Padrão
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('auditoria.combustivel_salvar_media_padrao') }}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Modelo do Veículo</label>
                    {% if modelos_pendentes %}
                    <select name="modelo" class="form-select" id="selectModelo">
                        <option value="">Selecione ou digite...</option>
                        {% for m in modelos_pendentes %}
                        <option value="{{ m }}">{{ m }}</option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <input type="text" name="modelo" class="form-control" placeholder="Ex: 008-OF 1721 EURO V" required>
                    {% endif %}
                </div>
                <div class="col-md-2">
                    <label class="form-label">Categoria</label>
                    <select name="categoria" class="form-select">
                        <option value="">Selecione</option>
                        <option value="onibus">Ônibus</option>
                        <option value="micro">Micro-ônibus</option>
                        <option value="van">Van</option>
                        <option value="sprinter">Sprinter</option>
                        <option value="utilitario">Utilitário</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Km/L Referência *</label>
                    <input type="number" name="media_kml_referencia" class="form-control"
                           step="0.01" min="0.1" required placeholder="Ex: 3.50">
                </div>
                <div class="col-md-1">
                    <label class="form-label">Km/L Mín.</label>
                    <input type="number" name="kml_minimo_aceitavel" class="form-control"
                           step="0.01" min="0" placeholder="Ex: 2.00">
                </div>
                <div class="col-md-1">
                    <label class="form-label">Km/L Máx.</label>
                    <input type="number" name="kml_maximo_aceitavel" class="form-control"
                           step="0.01" min="0" placeholder="Ex: 5.00">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Observações</label>
                    <input type="text" name="observacoes" class="form-control" placeholder="Opcional">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-check-lg"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if modelos_pendentes %}
<div class="alert alert-warning mb-4">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>{{ modelos_pendentes|length }} modelo(s)</strong> encontrados nas importações ainda sem média padrão cadastrada:
    {% for m in modelos_pendentes %}
    <span class="badge bg-secondary">{{ m }}</span>
    {% endfor %}
</div>
{% endif %}

<!-- Tabela de médias cadastradas -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-list-check"></i> Médias Cadastradas ({{ medias|length }})
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Modelo</th>
                        <th>Categoria</th>
                        <th class="text-end">Km/L Referência</th>
                        <th class="text-end">Km/L Mínimo</th>
                        <th class="text-end">Km/L Máximo</th>
                        <th>Observações</th>
                        <th>Status</th>
                        <th width="200">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mp in medias %}
                    <tr class="{{ 'table-secondary' if not mp.ativo }}">
                        <td><strong>{{ mp.modelo }}</strong></td>
                        <td>
                            {% if mp.categoria == 'onibus' %}
                            <span class="badge bg-primary">Ônibus</span>
                            {% elif mp.categoria == 'micro' %}
                            <span class="badge bg-info">Micro-ônibus</span>
                            {% elif mp.categoria == 'van' %}
                            <span class="badge bg-success">Van</span>
                            {% elif mp.categoria == 'sprinter' %}
                            <span class="badge bg-warning text-dark">Sprinter</span>
                            {% elif mp.categoria == 'utilitario' %}
                            <span class="badge bg-secondary">Utilitário</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end"><strong>{{ "%.2f"|format(mp.media_kml_referencia) }}</strong></td>
                        <td class="text-end">{{ "%.2f"|format(mp.kml_minimo_aceitavel) if mp.kml_minimo_aceitavel else '-' }}</td>
                        <td class="text-end">{{ "%.2f"|format(mp.kml_maximo_aceitavel) if mp.kml_maximo_aceitavel else '-' }}</td>
                        <td>{{ mp.observacoes or '-' }}</td>
                        <td>
                            {% if mp.ativo %}
                            <span class="badge bg-success">Ativo</span>
                            {% else %}
                            <span class="badge bg-secondary">Inativo</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    data-bs-toggle="modal" data-bs-target="#editModal{{ mp.id }}"
                                    title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{ url_for('auditoria.combustivel_toggle_media_padrao', id=mp.id) }}"
                                  style="display:inline">
                                <button type="submit" class="btn btn-sm btn-outline-{{ 'warning' if mp.ativo else 'success' }}"
                                        title="{{ 'Desativar' if mp.ativo else 'Ativar' }}">
                                    <i class="bi bi-{{ 'pause' if mp.ativo else 'play' }}"></i>
                                </button>
                            </form>
                        </td>
                    </tr>

                    <!-- Modal de edição -->
                    <div class="modal fade" id="editModal{{ mp.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{{ url_for('auditoria.combustivel_editar_media_padrao', id=mp.id) }}">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Editar - {{ mp.modelo }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Categoria</label>
                                            <select name="categoria" class="form-select">
                                                <option value="">Selecione</option>
                                                <option value="onibus" {{ 'selected' if mp.categoria == 'onibus' }}>Ônibus</option>
                                                <option value="micro" {{ 'selected' if mp.categoria == 'micro' }}>Micro-ônibus</option>
                                                <option value="van" {{ 'selected' if mp.categoria == 'van' }}>Van</option>
                                                <option value="sprinter" {{ 'selected' if mp.categoria == 'sprinter' }}>Sprinter</option>
                                                <option value="utilitario" {{ 'selected' if mp.categoria == 'utilitario' }}>Utilitário</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Km/L Referência *</label>
                                            <input type="number" name="media_kml_referencia" class="form-control"
                                                   step="0.01" min="0.1" value="{{ mp.media_kml_referencia }}" required>
                                        </div>
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Km/L Mínimo Aceitável</label>
                                                <input type="number" name="kml_minimo_aceitavel" class="form-control"
                                                       step="0.01" min="0" value="{{ mp.kml_minimo_aceitavel or '' }}">
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Km/L Máximo Aceitável</label>
                                                <input type="number" name="kml_maximo_aceitavel" class="form-control"
                                                       step="0.01" min="0" value="{{ mp.kml_maximo_aceitavel or '' }}">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Observações</label>
                                            <input type="text" name="observacoes" class="form-control"
                                                   value="{{ mp.observacoes or '' }}">
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Salvar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            Nenhuma média padrão cadastrada. Use o formulário acima para cadastrar.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
