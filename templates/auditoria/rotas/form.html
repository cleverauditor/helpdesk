{% extends 'base.html' %}

{% block title %}{{ 'Editar' if rota else 'Nova' }} Rota - Auditoria{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-signpost-2"></i>
        {{ 'Editar Rota: ' + rota.tag if rota else 'Nova Rota' }}
    </h2>
    <a href="{{ url_for('auditoria.lista_rotas') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pencil"></i> Dados da Rota
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Tag *</label>
                                <input type="text" name="tag" class="form-control" required
                                       value="{{ rota.tag if rota else '' }}"
                                       placeholder="Identificador único">
                                <div class="form-text">Ex: RT001, LINHA-A</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Nome</label>
                                <input type="text" name="nome" class="form-control"
                                       value="{{ rota.nome if rota else '' }}"
                                       placeholder="Nome descritivo da rota">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cliente *</label>
                                <select name="cliente_id" class="form-select" required>
                                    <option value="">Selecione o cliente</option>
                                    {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}"
                                            {{ 'selected' if rota and rota.cliente_id == cliente.id }}>
                                        {{ cliente.nome }}{% if cliente.cnpj %} ({{ cliente.cnpj }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <a href="{{ url_for('auditoria.criar_cliente') }}" target="_blank">
                                        <i class="bi bi-plus"></i> Cadastrar novo cliente
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Modal</label>
                                <select name="modal_id" class="form-select">
                                    <option value="">Selecione o modal</option>
                                    {% for modal in modais %}
                                    <option value="{{ modal.id }}"
                                            {{ 'selected' if rota and rota.modal_id == modal.id }}>
                                        {{ modal.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">KM Atual</label>
                                <input type="number" name="km_atual" class="form-control" step="0.01"
                                       value="{{ rota.km_atual if rota else 0 }}"
                                       placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Data de Implantação</label>
                                <input type="date" name="data_implantacao" class="form-control"
                                       value="{{ rota.data_implantacao.strftime('%Y-%m-%d') if rota and rota.data_implantacao else '' }}">
                            </div>
                        </div>
                        {% if rota %}
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" name="ativo" value="1"
                                           {{ 'checked' if rota.ativo }}>
                                    <label class="form-check-label">Ativa</label>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Turno -->
                    <div class="card bg-light mb-3">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-clock"></i> Turno</span>
                            <a href="{{ url_for('auditoria.turnos_padrao') }}" class="btn btn-sm btn-outline-secondary" target="_blank">
                                <i class="bi bi-gear"></i> Gerenciar Turnos
                            </a>
                        </div>
                        <div class="card-body py-2">
                            <div class="row">
                                <div class="col-md-12 mb-2">
                                    <label class="form-label small">Selecionar Turno Padrão</label>
                                    <select id="turno_padrao_select" class="form-select form-select-sm" onchange="preencherTurno(this)">
                                        <option value="">-- Preencher manualmente --</option>
                                        {% for tp in turnos_padrao %}
                                        <option value="{{ tp.id }}"
                                                data-nome="{{ tp.nome }}"
                                                data-inicio="{{ tp.horario_inicio.strftime('%H:%M') }}"
                                                data-termino="{{ tp.horario_termino.strftime('%H:%M') }}">
                                            {{ tp.nome }} ({{ tp.horario_formatado() }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-2">
                                        <label class="form-label small">Nome do Turno</label>
                                        <input type="text" name="turno_nome" id="turno_nome" class="form-control form-control-sm"
                                               value="{{ turno.nome if turno else '' }}"
                                               placeholder="Ex: Manhã">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2">
                                        <label class="form-label small">Horário Início</label>
                                        <input type="time" name="turno_inicio" id="turno_inicio" class="form-control form-control-sm"
                                               value="{{ turno.horario_inicio.strftime('%H:%M') if turno and turno.horario_inicio else '' }}">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2">
                                        <label class="form-label small">Horário Término</label>
                                        <input type="time" name="turno_termino" id="turno_termino" class="form-control form-control-sm"
                                               value="{{ turno.horario_termino.strftime('%H:%M') if turno and turno.horario_termino else '' }}">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2">
                                        <label class="form-label small">Tempo Trajeto (min)</label>
                                        <input type="number" name="turno_tempo" id="turno_tempo" class="form-control form-control-sm"
                                               value="{{ turno.tempo_trajeto_minutos if turno and turno.tempo_trajeto_minutos else '' }}"
                                               placeholder="Auto do KML">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Arquivo KML (Rota Planejada)</label>
                        <input type="file" name="arquivo_kml" class="form-control" accept=".kml,.kmz">
                        {% if rota and rota.arquivo_kml %}
                        <div class="form-text">
                            <i class="bi bi-file-earmark"></i>
                            Arquivo atual: {{ rota.arquivo_kml_nome }}
                            <a href="{{ url_for('auditoria.download_kml', tipo='rota', id=rota.id) }}"
                               class="ms-2" target="_blank">
                                <i class="bi bi-download"></i> Baixar
                            </a>
                        </div>
                        {% else %}
                        <div class="form-text">Selecione o arquivo KML ou KMZ da rota planejada</div>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> {{ 'Salvar Alterações' if rota else 'Criar Rota' }}
                        </button>
                        <a href="{{ url_for('auditoria.lista_rotas') }}" class="btn btn-outline-secondary">
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Informações
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    <strong>Tag:</strong> Identificador único da rota no sistema.
                </p>
                <p class="small text-muted">
                    <strong>Modal:</strong> Tipo de veículo utilizado na rota.
                </p>
                <p class="small text-muted">
                    <strong>Arquivo KML:</strong> Arquivo com as coordenadas da rota planejada.
                    Este arquivo será usado para comparar com os dados do rastreador durante a auditoria.
                </p>
                {% if not modais %}
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle"></i>
                    Nenhum modal cadastrado.
                    <a href="{{ url_for('auditoria.modais') }}">Cadastrar modais</a>
                </div>
                {% endif %}
            </div>
        </div>

        {% if rota %}
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Informações do Registro
            </div>
            <div class="card-body small">
                <p class="mb-1">
                    <strong>Criado em:</strong><br>
                    {{ rota.criado_em.strftime('%d/%m/%Y %H:%M') }}
                </p>
                <p class="mb-1">
                    <strong>Atualizado em:</strong><br>
                    {{ rota.atualizado_em.strftime('%d/%m/%Y %H:%M') }}
                </p>
                <p class="mb-0">
                    <strong>Auditorias:</strong>
                    {{ rota.auditorias.count() }}
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function preencherTurno(select) {
    const option = select.options[select.selectedIndex];
    if (option.value) {
        document.getElementById('turno_nome').value = option.dataset.nome || '';
        document.getElementById('turno_inicio').value = option.dataset.inicio || '';
        document.getElementById('turno_termino').value = option.dataset.termino || '';
    }
}
</script>
{% endblock %}
